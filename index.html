<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resource ClassHub - Created by AA²</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/meshesha/PowerPointToHTML@latest/pptxjs/js/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/meshesha/PowerPointToHTML@latest/pptxjs/js/filereader.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/meshesha/PowerPointToHTML@latest/pptxjs/js/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/meshesha/PowerPointToHTML@latest/pptxjs/js/pptxjs.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/meshesha/PowerPointToHTML@latest/pptxjs/js/divs2slides.js"></script>
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    
    :root {
      --cvsu-green: #006400;
      --cvsu-green-dark: #004d00;
      --cvsu-green-light: #008000;
    }
    
    .bg-cvsu-green { background-color: var(--cvsu-green); }
    .bg-cvsu-green-dark { background-color: var(--cvsu-green-dark); }
    .bg-cvsu-green-light { background-color: var(--cvsu-green-light); }
    .text-cvsu-green { color: var(--cvsu-green); }
    .border-cvsu-green { border-color: var(--cvsu-green); }
    
    .hover-cvsu:hover {
      background-color: var(--cvsu-green-dark);
    }
    
    .sidebar-transition {
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .fade-in {
      animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    @keyframes fadeIn {
      from { 
        opacity: 0;
        transform: translateY(10px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .card-hover {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .card-hover:hover {
      transform: translateY(-6px) scale(1.02);
      box-shadow: 0 20px 40px rgba(0, 100, 0, 0.15);
    }
    
    .smooth-transition {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .scroll-smooth {
      scroll-behavior: smooth;
    }
    
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--cvsu-green);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--cvsu-green-dark);
    }
    
    .notification-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #ef4444;
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    .modal-backdrop {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(2px);
    }
    
    .resource-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.5rem;
    }
    
    @media (max-width: 640px) {
      .resource-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .upload-zone {
      border: 2px dashed var(--cvsu-green);
      transition: all 0.3s ease;
    }
    
    .upload-zone.drag-over {
      background: rgba(0, 100, 0, 0.05);
      border-color: var(--cvsu-green-dark);
    }
    
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .profile-banner {
      height: 200px;
      background: linear-gradient(135deg, var(--cvsu-green) 0%, var(--cvsu-green-light) 100%);
    }

    .toggle {
      appearance: none;
      width: 48px;
      height: 24px;
      background: #cbd5e0;
      border-radius: 12px;
      position: relative;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle:checked {
      background: var(--cvsu-green);
    }

    .toggle::before {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: transform 0.3s;
    }

    .toggle:checked::before {
      transform: translateX(24px);
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--cvsu-green);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gray-50 h-full overflow-x-hidden scroll-smooth"><!-- Auth Modal -->
  <div id="authModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-lg shadow-2xl max-w-md w-full p-8 fade-in">
    <div class="text-center mb-6">
     <h2 class="text-3xl font-bold text-cvsu-green mb-2">Welcome to Resource ClassHub</h2>
     <p class="text-gray-600">Created by AA²</p>
    </div><!-- Login Form -->
    <div id="loginForm"><button id="googleLoginBtn" class="w-full bg-white border-2 border-gray-300 text-gray-700 py-3 rounded-lg font-semibold mb-3 hover:bg-gray-50 transition flex items-center justify-center gap-2">
      <svg class="w-5 h-5" viewbox="0 0 24 24">
       <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" /><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" /><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" /><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
      </svg> Sign in with Google </button>
     <div class="relative my-4">
      <div class="absolute inset-0 flex items-center">
       <div class="w-full border-t border-gray-300"></div>
      </div>
      <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">Or sign in with email</span>
      </div>
     </div>
     <form id="emailLoginForm" class="space-y-4">
      <div><label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label> <input type="email" id="loginEmail" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cvsu-green focus:border-transparent" placeholder="you@example.com">
      </div>
      <div><label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label> <input type="password" id="loginPassword" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cvsu-green focus:border-transparent" placeholder="••••••••">
      </div><button type="submit" class="w-full bg-cvsu-green text-white py-3 rounded-lg font-semibold hover-cvsu transition"> Sign In </button>
     </form>
     <p class="text-center mt-4 text-sm text-gray-600">Don't have an account? <button id="showRegisterBtn" class="text-cvsu-green font-semibold hover:underline">Sign up</button></p>
    </div><!-- Register Form -->
    <div id="registerForm" class="hidden">
     <form id="emailRegisterForm" class="space-y-4">
      <div><label for="registerName" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label> <input type="text" id="registerName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cvsu-green focus:border-transparent" placeholder="Juan Dela Cruz">
      </div>
      <div><label for="registerEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label> <input type="email" id="registerEmail" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cvsu-green focus:border-transparent" placeholder="you@example.com">
      </div>
      <div><label for="registerPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label> <input type="password" id="registerPassword" required minlength="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cvsu-green focus:border-transparent" placeholder="••••••••">
      </div><button type="submit" class="w-full bg-cvsu-green text-white py-3 rounded-lg font-semibold hover-cvsu transition"> Create Account </button>
     </form>
     <p class="text-center mt-4 text-sm text-gray-600">Already have an account? <button id="showLoginBtn" class="text-cvsu-green font-semibold hover:underline">Sign in</button></p>
    </div>
   </div>
  </div><!-- Role Code Modal -->
  <div id="roleModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-lg shadow-2xl max-w-md w-full p-8 fade-in">
    <h2 class="text-2xl font-bold text-cvsu-green mb-4">Select Your Role</h2>
    <p class="text-gray-600 mb-6">Enter your membership code or continue as a guest</p>
    <div class="space-y-4">
     <div><label for="roleCodeInput" class="block text-sm font-medium text-gray-700 mb-1">Role Code (Optional)</label> <input type="text" id="roleCodeInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cvsu-green focus:border-transparent" placeholder="Enter your role code">
      <p class="text-xs text-gray-500 mt-1">Leave empty to continue as Guest</p>
     </div>
     <div class="bg-gray-50 p-4 rounded-lg text-sm">
      <p class="font-semibold text-gray-700 mb-2">Available Roles:</p>
      <ul class="space-y-1 text-gray-600">
       <li>• <strong>student</strong> - Student access</li>
       <li>• Guest (no code needed)</li>
       <li>• Other role codes are private and only for authorized members</li>
      </ul>
     </div><button id="submitRoleBtn" class="w-full bg-cvsu-green text-white py-3 rounded-lg font-semibold hover-cvsu transition"> Continue </button>
    </div>
   </div>
  </div><!-- Main App Container -->
  <div id="appContainer" class="hidden"><!-- Top Navigation Bar -->
   <nav class="bg-cvsu-green text-white shadow-lg fixed top-0 left-0 right-0 z-40">
    <div class="px-4 py-3 flex items-center justify-between">
     <div class="flex items-center gap-4"><button id="sidebarToggle" class="lg:hidden">
       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
       </svg></button>
      <h1 class="text-xl font-bold">Resource ClassHub</h1>
     </div>
     <div class="flex items-center gap-4"><!-- Search Icon --> <button id="searchBtn" class="hover:bg-cvsu-green-dark p-2 rounded-lg transition">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
       </svg></button> <!-- Notifications --> <button id="notifBtn" class="hover:bg-cvsu-green-dark p-2 rounded-lg transition relative">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
       </svg><span id="notifBadge" class="notification-badge">3</span> </button> <!-- User Profile --> <button id="profileMenuBtn" class="flex items-center gap-2 hover:bg-cvsu-green-dark p-2 rounded-lg transition"> <img id="navProfilePic" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23006400'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E" alt="Profile" class="w-8 h-8 rounded-full bg-white"> <span id="navUserName" class="hidden md:block font-semibold">User</span> </button>
     </div>
    </div><!-- Search Bar (Hidden by default) -->
    <div id="searchBar" class="hidden bg-cvsu-green-dark px-4 py-3">
     <div class="max-w-2xl mx-auto relative"><input type="text" id="searchInput" placeholder="Search resources, classes, users..." class="w-full px-4 py-2 pr-10 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-white"> <button id="closeSearchBtn" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
       </svg></button>
     </div>
    </div>
   </nav><!-- Sidebar -->
   <aside id="sidebar" class="fixed left-0 top-0 h-full w-64 bg-white shadow-lg z-30 transform -translate-x-full lg:translate-x-0 sidebar-transition pt-16">
    <div class="p-4 h-full overflow-y-auto">
     <nav class="space-y-2"><button data-page="dashboard" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-cvsu-green text-white transition text-left">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
       </svg><span class="font-semibold">Dashboard</span> </button> <button data-page="notes" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition text-left">
       <svg class="w-5 h-5 text-cvsu-green" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
       </svg><span class="font-semibold">Notes Library</span> </button> <button data-page="ppt" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition text-left">
       <svg class="w-5 h-5 text-cvsu-green" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
       </svg><span class="font-semibold">PPT Library</span> </button> <button data-page="upload" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition text-left">
       <svg class="w-5 h-5 text-cvsu-green" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
       </svg><span class="font-semibold">Upload</span> </button> <button data-page="classes" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition text-left">
       <svg class="w-5 h-5 text-cvsu-green" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
       </svg><span class="font-semibold">Classes</span> </button> <button data-page="assignments" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition text-left">
       <svg class="w-5 h-5 text-cvsu-green" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
       </svg><span class="font-semibold">Assignments</span> </button> <button data-page="announcements" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition text-left">
       <svg class="w-5 h-5 text-cvsu-green" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" />
       </svg><span class="font-semibold">Announcements</span> </button> <button data-page="forums" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition text-left">
       <svg class="w-5 h-5 text-cvsu-green" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" />
       </svg><span class="font-semibold">Forums</span> </button> <button data-page="calendar" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition text-left">
       <svg class="w-5 h-5 text-cvsu-green" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
       </svg><span class="font-semibold">Calendar</span> </button> <button data-page="profile" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition text-left">
       <svg class="w-5 h-5 text-cvsu-green" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
       </svg><span class="font-semibold">Profile</span> </button> <button data-page="settings" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition text-left">
       <svg class="w-5 h-5 text-cvsu-green" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
       </svg><span class="font-semibold">Settings</span> </button> <button data-page="admin" id="adminNavBtn" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition text-left hidden">
       <svg class="w-5 h-5 text-cvsu-green" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
       </svg><span class="font-semibold">Admin Panel</span> </button> <button id="logoutBtn" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-red-50 text-red-600 transition text-left mt-4">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
       </svg><span class="font-semibold">Logout</span> </button>
     </nav>
    </div>
   </aside><!-- Main Content Area -->
   <main id="mainContent" class="lg:ml-64 pt-16 min-h-full">
    <div id="pageContent" class="p-6"><!-- Dynamic content will be loaded here -->
    </div>
   </main><!-- Scroll to Top Button --> <button id="scrollTopBtn" class="hidden fixed bottom-6 right-6 bg-cvsu-green text-white p-3 rounded-full shadow-lg hover-cvsu transition z-30">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
    </svg></button>
  </div><!-- PowerPoint Viewer Modal -->
  <div id="pptViewerModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-lg shadow-2xl w-full h-full max-w-7xl max-h-[90vh] flex flex-col fade-in"><!-- Header -->
    <div class="flex items-center justify-between p-4 border-b border-gray-200 bg-cvsu-green text-white rounded-t-lg">
     <div class="flex items-center gap-3">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
      </svg>
      <h3 id="pptViewerTitle" class="text-xl font-bold">PowerPoint Viewer</h3>
     </div>
     <div class="flex items-center gap-2"><button id="fullscreenPPTBtn" class="hover:bg-cvsu-green-dark p-2 rounded-lg transition" title="Fullscreen">
       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
       </svg></button> <button id="closePPTViewer" class="hover:bg-cvsu-green-dark p-2 rounded-lg transition">
       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
       </svg></button>
     </div>
    </div><!-- PPT Content -->
    <div id="pptViewerContent" class="flex-1 overflow-auto p-6 bg-gray-50"><!-- Presentation will be rendered here -->
    </div><!-- Navigation Controls -->
    <div id="pptControls" class="hidden border-t border-gray-200 p-4 bg-white rounded-b-lg">
     <div class="flex items-center justify-between"><button id="pptPrevSlide" class="bg-cvsu-green text-white px-4 py-2 rounded-lg font-semibold hover-cvsu transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
       </svg> Previous </button>
      <div class="text-center">
       <p class="text-sm text-gray-600">Slide <span id="currentSlide">1</span> of <span id="totalSlides">1</span></p>
      </div><button id="pptNextSlide" class="bg-cvsu-green text-white px-4 py-2 rounded-lg font-semibold hover-cvsu transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"> Next 
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
       </svg></button>
     </div>
    </div>
   </div>
  </div><!-- Footer -->
  <footer id="appFooter" class="hidden lg:ml-64 bg-white border-t border-gray-200 py-6 mt-12">
   <div class="px-6 text-center text-gray-600">
    <p class="font-semibold">Created by AA��</p>
    <p class="text-sm mt-1">Resource ClassHub © 2024 | All Rights Reserved</p>
   </div>
  </footer>
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDcqcitLdyRytuUQTjJTmWgupL69OYFFOM",
      authDomain: "rtdb-supabase.firebaseapp.com",
      databaseURL: "https://rtdb-supabase-default-rtdb.firebaseio.com",
      projectId: "rtdb-supabase",
      storageBucket: "rtdb-supabase.firebasestorage.app",
      messagingSenderId: "942223024342",
      appId: "1:942223024342:web:98c97e0d2d7c6299ab2977",
      measurementId: "G-WZPR57DDMF"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();
    const storage = firebase.storage();

    // Firebase Storage is configured above - no other cloud storage needed

    // Role codes
    const ROLE_CODES = {
      'student': 'student',
      'teacher': 'teacher',
      'Teacher123': 'teacher',
      '12345imamemberoftheAA': 'aa_member',
      '123sixonenineAA': 'officer',
      'Athanmeir@1': 'director'
    };

    // Current user state
    let currentUser = null;
    let currentUserRole = 'guest';
    let allResources = [];
    let allClasses = [];
    let allAssignments = [];
    let allAnnouncements = [];
    let allForumTopics = [];

    // DOM Elements
    const loadingScreen = document.getElementById('loadingScreen');
    const authModal = document.getElementById('authModal');
    const roleModal = document.getElementById('roleModal');
    const appContainer = document.getElementById('appContainer');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const pageContent = document.getElementById('pageContent');
    const searchBar = document.getElementById('searchBar');
    const searchBtn = document.getElementById('searchBtn');
    const closeSearchBtn = document.getElementById('closeSearchBtn');
    const searchInput = document.getElementById('searchInput');
    const scrollTopBtn = document.getElementById('scrollTopBtn');
    const appFooter = document.getElementById('appFooter');

    // Initialize app
    auth.onAuthStateChanged((user) => {
      if (user) {
        currentUser = user;
        checkUserRole(user.uid);
      } else {
        showAuthModal();
      }
    });

    // Show/hide loading screen
    function hideLoading() {
      setTimeout(() => {
        loadingScreen.classList.add('hidden');
      }, 500);
    }

    // Auth Modal Controls
    function showAuthModal() {
      hideLoading();
      authModal.classList.remove('hidden');
    }

    function hideAuthModal() {
      authModal.classList.add('hidden');
    }

    document.getElementById('showRegisterBtn').addEventListener('click', () => {
      loginForm.classList.add('hidden');
      registerForm.classList.remove('hidden');
    });

    document.getElementById('showLoginBtn').addEventListener('click', () => {
      registerForm.classList.add('hidden');
      loginForm.classList.remove('hidden');
    });

    // Google Login
    document.getElementById('googleLoginBtn').addEventListener('click', async () => {
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
      } catch (error) {
        showToast('Google login failed: ' + error.message, 'error');
      }
    });

    // Email Login
    document.getElementById('emailLoginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (error) {
        showToast('Login failed: ' + error.message, 'error');
      }
    });

    // Email Registration
    document.getElementById('emailRegisterForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('registerName').value;
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      
      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        await userCredential.user.updateProfile({ displayName: name });
        
        // Create user in database
        await database.ref('users/' + userCredential.user.uid).set({
          name: name,
          email: email,
          role: 'guest',
          joinDate: Date.now(),
          profilePic: '',
          bio: 'New member of Resource ClassHub',
          yearLevel: '',
          course: '',
          badges: [],
          activityTimeline: [],
          totalXP: 0,
          resourcesViewed: 0,
          assignmentsDone: 0,
          forumPosts: 0
        });
      } catch (error) {
        showToast('Registration failed: ' + error.message, 'error');
      }
    });

    // Check user role
    async function checkUserRole(uid) {
      const userRef = database.ref('users/' + uid);
      const snapshot = await userRef.once('value');
      
      if (snapshot.exists()) {
        const userData = snapshot.val();
        if (userData.role && userData.role !== 'guest') {
          currentUserRole = userData.role;
          hideAuthModal();
          await loadAllData();
          showApp();
        } else {
          showRoleModal();
        }
      } else {
        showRoleModal();
      }
    }

    // Role Modal
    function showRoleModal() {
      hideAuthModal();
      hideLoading();
      roleModal.classList.remove('hidden');
    }

    function hideRoleModal() {
      roleModal.classList.add('hidden');
    }

    document.getElementById('submitRoleBtn').addEventListener('click', async () => {
      const roleCode = document.getElementById('roleCodeInput').value.trim();
      let assignedRole = 'guest';
      
      if (roleCode) {
        if (ROLE_CODES[roleCode]) {
          assignedRole = ROLE_CODES[roleCode];
        } else {
          showToast('Invalid role code. Continuing as guest.', 'warning');
        }
      }
      
      // Check if user exists
      const userRef = database.ref('users/' + currentUser.uid);
      const snapshot = await userRef.once('value');
      
      if (snapshot.exists()) {
        // Update existing user
        await userRef.update({ role: assignedRole });
      } else {
        // Create new user
        await userRef.set({
          name: currentUser.displayName || 'User',
          email: currentUser.email,
          role: assignedRole,
          joinDate: Date.now(),
          profilePic: currentUser.photoURL || '',
          bio: 'New member of Resource ClassHub',
          yearLevel: '',
          course: '',
          badges: [],
          activityTimeline: [],
          totalXP: 0,
          resourcesViewed: 0,
          assignmentsDone: 0,
          forumPosts: 0
        });
      }
      
      currentUserRole = assignedRole;
      hideRoleModal();
      await loadAllData();
      showApp();
    });

    // User data
    let userData = {
      activityTimeline: [],
      badges: [],
      totalXP: 0,
      resourcesViewed: 0,
      assignmentsDone: 0,
      forumPosts: 0
    };

    // Load all data from Firebase
    async function loadAllData() {
      try {
        // Load user data
        const userSnapshot = await database.ref('users/' + currentUser.uid).once('value');
        if (userSnapshot.exists()) {
          const data = userSnapshot.val();
          userData = {
            activityTimeline: data.activityTimeline || [],
            badges: data.badges || [],
            totalXP: data.totalXP || 0,
            resourcesViewed: data.resourcesViewed || 0,
            assignmentsDone: data.assignmentsDone || 0,
            forumPosts: data.forumPosts || 0,
            bio: data.bio || 'New member of Resource ClassHub',
            yearLevel: data.yearLevel || '',
            course: data.course || '',
            bannerURL: data.bannerURL || ''
          };
        }

        // Load resources from Firebase
        const resourcesSnapshot = await database.ref('resources').once('value');
        if (resourcesSnapshot.exists()) {
          allResources = Object.entries(resourcesSnapshot.val()).map(([id, data]) => ({
            id,
            ...data
          }));
          console.log('Loaded resources:', allResources.length);
        } else {
          allResources = [];
          console.log('No resources found in database');
        }

        // Load classes
        const classesSnapshot = await database.ref('classes').once('value');
        if (classesSnapshot.exists()) {
          allClasses = Object.entries(classesSnapshot.val()).map(([id, data]) => ({
            id,
            ...data
          }));
        } else {
          allClasses = [];
        }

        // Load assignments
        const assignmentsSnapshot = await database.ref('assignments').once('value');
        if (assignmentsSnapshot.exists()) {
          allAssignments = Object.entries(assignmentsSnapshot.val()).map(([id, data]) => ({
            id,
            ...data
          }));
        } else {
          allAssignments = [];
        }

        // Load announcements
        const announcementsSnapshot = await database.ref('announcements').once('value');
        if (announcementsSnapshot.exists()) {
          allAnnouncements = Object.entries(announcementsSnapshot.val()).map(([id, data]) => ({
            id,
            ...data
          }));
        } else {
          allAnnouncements = [];
        }

        // Load forum topics
        const forumsSnapshot = await database.ref('forums').once('value');
        if (forumsSnapshot.exists()) {
          allForumTopics = Object.entries(forumsSnapshot.val()).map(([id, data]) => ({
            id,
            ...data
          }));
        } else {
          allForumTopics = [];
        }

        console.log('All data loaded:', {
          resources: allResources.length,
          classes: allClasses.length,
          assignments: allAssignments.length,
          announcements: allAnnouncements.length,
          forums: allForumTopics.length
        });
      } catch (error) {
        console.error('Error loading data:', error);
        allResources = [];
        allClasses = [];
        allAssignments = [];
        allAnnouncements = [];
        allForumTopics = [];
      }
    }

    // Show main app
    function showApp() {
      appContainer.classList.remove('hidden');
      appFooter.classList.remove('hidden');
      
      // Set user info in nav
      document.getElementById('navUserName').textContent = currentUser.displayName || 'User';
      const profilePic = currentUser.photoURL || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23006400"%3E%3Cpath d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/%3E%3C/svg%3E';
      document.getElementById('navProfilePic').src = profilePic;
      
      // Show admin button for teachers and directors
      if (currentUserRole === 'teacher' || currentUserRole === 'director') {
        document.getElementById('adminNavBtn').classList.remove('hidden');
      }
      
      loadPage('dashboard');
    }

    // Sidebar toggle for mobile
    sidebarToggle.addEventListener('click', () => {
      sidebar.classList.toggle('-translate-x-full');
    });

    // Close sidebar on mobile when clicking outside
    document.addEventListener('click', (e) => {
      if (window.innerWidth < 1024) {
        if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
          sidebar.classList.add('-translate-x-full');
        }
      }
    });

    // Navigation
    document.querySelectorAll('.nav-item').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const page = e.currentTarget.dataset.page;
        
        // Add fade out effect
        pageContent.style.opacity = '0';
        pageContent.style.transform = 'translateY(10px)';
        
        setTimeout(() => {
          loadPage(page);
          
          // Fade in
          pageContent.style.opacity = '1';
          pageContent.style.transform = 'translateY(0)';
        }, 150);
        
        // Close sidebar on mobile
        if (window.innerWidth < 1024) {
          sidebar.classList.add('-translate-x-full');
        }
        
        // Update active state with smooth transition
        document.querySelectorAll('.nav-item').forEach(b => {
          b.classList.remove('bg-cvsu-green', 'text-white');
          b.classList.add('hover:bg-gray-100');
          const svg = b.querySelector('svg');
          if (svg) svg.classList.add('text-cvsu-green');
        });
        e.currentTarget.classList.add('bg-cvsu-green', 'text-white');
        e.currentTarget.classList.remove('hover:bg-gray-100');
        const svg = e.currentTarget.querySelector('svg');
        if (svg) svg.classList.remove('text-cvsu-green');
      });
    });

    // Add smooth transition to page content
    pageContent.style.transition = 'opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1), transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';

    // Search functionality
    searchBtn.addEventListener('click', () => {
      searchBar.classList.toggle('hidden');
      if (!searchBar.classList.contains('hidden')) {
        searchInput.focus();
      }
    });

    closeSearchBtn.addEventListener('click', () => {
      searchBar.classList.add('hidden');
      searchInput.value = '';
    });

    // Search input
    searchInput.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      if (query.length > 2) {
        performSearch(query);
      }
    });

    function performSearch(query) {
      const results = allResources.filter(r => 
        r.title.toLowerCase().includes(query) || 
        r.author.toLowerCase().includes(query) ||
        r.course.toLowerCase().includes(query)
      );
      
      if (results.length > 0) {
        showToast(`Found ${results.length} results for "${query}"`, 'success');
      }
    }

    // Scroll to top button
    window.addEventListener('scroll', () => {
      if (window.pageYOffset > 300) {
        scrollTopBtn.classList.remove('hidden');
      } else {
        scrollTopBtn.classList.add('hidden');
      }
    });

    scrollTopBtn.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // Profile menu dropdown
    const profileMenuBtn = document.getElementById('profileMenuBtn');
    const notifBtn = document.getElementById('notifBtn');
    
    profileMenuBtn.addEventListener('click', () => {
      showProfileDropdown();
    });

    notifBtn.addEventListener('click', () => {
      showNotificationsDropdown();
    });

    function showProfileDropdown() {
      const existingDropdown = document.getElementById('profileDropdown');
      if (existingDropdown) {
        existingDropdown.remove();
        return;
      }

      const dropdown = document.createElement('div');
      dropdown.id = 'profileDropdown';
      dropdown.className = 'fixed right-4 top-16 bg-white rounded-lg shadow-xl border border-gray-200 w-64 z-50 fade-in';
      dropdown.innerHTML = `
        <div class="p-4 border-b border-gray-200">
          <p class="font-semibold text-gray-800">${currentUser.displayName || 'User'}</p>
          <p class="text-sm text-gray-600">${currentUser.email}</p>
        </div>
        <div class="py-2">
          <button onclick="loadPage('profile'); document.getElementById('profileDropdown').remove();" class="w-full text-left px-4 py-2 hover:bg-gray-100 transition flex items-center gap-2">
            <svg class="w-5 h-5 text-cvsu-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
            <span class="text-gray-700">View Profile</span>
          </button>
          <button onclick="loadPage('settings'); document.getElementById('profileDropdown').remove();" class="w-full text-left px-4 py-2 hover:bg-gray-100 transition flex items-center gap-2">
            <svg class="w-5 h-5 text-cvsu-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            <span class="text-gray-700">Settings</span>
          </button>
        </div>
        <div class="border-t border-gray-200 py-2">
          <button onclick="auth.signOut().then(() => location.reload());" class="w-full text-left px-4 py-2 hover:bg-red-50 transition flex items-center gap-2 text-red-600">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
            </svg>
            <span>Logout</span>
          </button>
        </div>
      `;
      document.body.appendChild(dropdown);

      setTimeout(() => {
        document.addEventListener('click', function closeDropdown(e) {
          if (!dropdown.contains(e.target) && !profileMenuBtn.contains(e.target)) {
            dropdown.remove();
            document.removeEventListener('click', closeDropdown);
          }
        });
      }, 100);
    }

    function showNotificationsDropdown() {
      const existingDropdown = document.getElementById('notifDropdown');
      if (existingDropdown) {
        existingDropdown.remove();
        return;
      }

      const dropdown = document.createElement('div');
      dropdown.id = 'notifDropdown';
      dropdown.className = 'fixed right-4 top-16 bg-white rounded-lg shadow-xl border border-gray-200 w-80 z-50 fade-in max-h-96 overflow-y-auto';
      dropdown.innerHTML = `
        <div class="p-4 border-b border-gray-200 flex items-center justify-between">
          <h3 class="font-bold text-gray-800">Notifications</h3>
          <button onclick="document.getElementById('notifBadge').textContent = '0';" class="text-sm text-cvsu-green hover:underline">Mark all read</button>
        </div>
        <div class="divide-y divide-gray-200">
          <div class="p-4 hover:bg-gray-50 cursor-pointer">
            <div class="flex gap-3">
              <div class="w-2 h-2 bg-cvsu-green rounded-full mt-2"></div>
              <div class="flex-1">
                <p class="text-sm font-semibold text-gray-800">New assignment posted</p>
                <p class="text-xs text-gray-600">CS301 - Database Design Project due next week</p>
                <p class="text-xs text-gray-500 mt-1">2 hours ago</p>
              </div>
            </div>
          </div>
          <div class="p-4 hover:bg-gray-50 cursor-pointer">
            <div class="flex gap-3">
              <div class="w-2 h-2 bg-cvsu-green rounded-full mt-2"></div>
              <div class="flex-1">
                <p class="text-sm font-semibold text-gray-800">Resource uploaded</p>
                <p class="text-xs text-gray-600">New lecture notes available for Data Structures</p>
                <p class="text-xs text-gray-500 mt-1">5 hours ago</p>
              </div>
            </div>
          </div>
          <div class="p-4 hover:bg-gray-50 cursor-pointer">
            <div class="flex gap-3">
              <div class="w-2 h-2 bg-cvsu-green rounded-full mt-2"></div>
              <div class="flex-1">
                <p class="text-sm font-semibold text-gray-800">Forum reply</p>
                <p class="text-xs text-gray-600">Someone replied to your question about recursion</p>
                <p class="text-xs text-gray-500 mt-1">1 day ago</p>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(dropdown);

      setTimeout(() => {
        document.addEventListener('click', function closeDropdown(e) {
          if (!dropdown.contains(e.target) && !notifBtn.contains(e.target)) {
            dropdown.remove();
            document.removeEventListener('click', closeDropdown);
          }
        });
      }, 100);
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        await auth.signOut();
        location.reload();
      } catch (error) {
        showToast('Logout failed: ' + error.message, 'error');
      }
    });

    // Toast notification system
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `fixed bottom-6 left-6 px-6 py-4 rounded-lg shadow-lg text-white z-50 fade-in ${
        type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
      }`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 4000);
    }

    // Page loader
    function loadPage(pageName) {
      pageContent.innerHTML = getPageContent(pageName);
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      // Attach event listeners after content is loaded
      attachPageEventListeners(pageName);
    }

    // Attach event listeners for specific pages
    function attachPageEventListeners(pageName) {
      if (pageName === 'upload') {
        setupUploadPage();
      } else if (pageName === 'notes' || pageName === 'ppt') {
        setupLibraryPage(pageName);
        setupResourceCards();
      } else if (pageName === 'settings') {
        setupSettingsPage();
      } else if (pageName === 'dashboard') {
        setupResourceCards();
      } else if (pageName === 'profile') {
        setupProfilePage();
      } else if (pageName === 'admin') {
        loadBadges();
        if (currentUserRole === 'director') {
          loadAllUsers();
        }
      }
    }

    // PowerPoint Viewer Modal State
    let pptSlides = [];
    let currentSlideIndex = 0;
    const CONVERT_API_SECRET = 'k6VkXuICZrUlTs8wd7ZOP1pydcjbIdzg';

    // Handle resource click
    function handleResourceClick(fileURL, title, fileType) {
      if (!fileURL || fileURL === 'null' || fileURL === 'undefined' || fileURL === '') {
        showToast('This resource has no file attached yet. Please upload a file.', 'warning');
        return;
      }
      
      // Check if it's a PowerPoint file
      if (fileType === 'PPT' || fileType === 'PPTX') {
        openPPTViewer(fileURL, title);
        return;
      }
      
      // For other files, open in new tab
      try {
        const newWindow = window.open(fileURL, '_blank', 'noopener,noreferrer');
        if (newWindow) {
          showToast('Opening resource...', 'success');
        } else {
          showToast('Popup blocked. Please allow popups for this site.', 'warning');
        }
      } catch (error) {
        showToast('Failed to open resource: ' + error.message, 'error');
      }
    }

    // Open PowerPoint Viewer
    async function openPPTViewer(fileURL, title) {
      const modal = document.getElementById('pptViewerModal');
      const contentDiv = document.getElementById('pptViewerContent');
      const controls = document.getElementById('pptControls');
      const titleElement = document.getElementById('pptViewerTitle');
      
      // Validate file URL more thoroughly
      if (!fileURL || fileURL === 'null' || fileURL === 'undefined' || fileURL === '' || fileURL.includes('undefined')) {
        modal.classList.remove('hidden');
        showPPTError('This presentation file is not available. The file URL is missing or invalid.');
        return;
      }
      
      // Reset state
      titleElement.textContent = title || 'PowerPoint Viewer';
      contentDiv.innerHTML = '<div class="flex items-center justify-center h-full"><div class="text-center"><div class="spinner mx-auto mb-4"></div><p class="text-gray-600">Loading presentation...</p></div></div>';
      controls.classList.add('hidden');
      modal.classList.remove('hidden');
      currentSlideIndex = 0;
      pptSlides = [];
      
      try {
        // Check if file exists first
        showToast('Checking file availability...', 'info');
        const headResponse = await fetch(fileURL, { method: 'HEAD' });
        if (!headResponse.ok) {
          throw new Error('File not found or inaccessible. Please re-upload the presentation.');
        }
        
        // Display PDF directly using Google Docs Viewer (no conversion needed)
        showToast('Loading presentation...', 'success');
        
        // Use Google Docs Viewer for PowerPoint files
        const encodedURL = encodeURIComponent(fileURL);
        contentDiv.innerHTML = `
          <div class="w-full h-full" style="min-height: 600px;">
            <iframe 
              src="https://docs.google.com/viewer?url=${encodedURL}&embedded=true" 
              class="w-full h-full border-0 rounded-lg"
              style="min-height: 600px;"
            ></iframe>
          </div>
        `;
        
        showToast('Presentation loaded successfully!', 'success');
        
      } catch (error) {
        console.error('PPT Viewer Error:', error);
        showPPTError(error.message || 'Failed to load presentation. The file may be missing or corrupted.');
      }
    }

    // Show specific slide
    function showSlide(index) {
      if (index < 0 || index >= pptSlides.length) return;
      
      pptSlides.forEach((slide, i) => {
        if (i === index) {
          slide.style.display = 'block';
        } else {
          slide.style.display = 'none';
        }
      });
      
      currentSlideIndex = index;
      document.getElementById('currentSlide').textContent = index + 1;
      
      // Update button states
      document.getElementById('pptPrevSlide').disabled = index === 0;
      document.getElementById('pptNextSlide').disabled = index === pptSlides.length - 1;
    }

    // Show error in PPT viewer
    function showPPTError(message) {
      const contentDiv = document.getElementById('pptViewerContent');
      contentDiv.innerHTML = `
        <div class="flex items-center justify-center h-full">
          <div class="text-center">
            <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <p class="text-gray-800 font-semibold mb-2">Unable to Load Presentation</p>
            <p class="text-gray-600 text-sm">${message}</p>
            <button onclick="document.getElementById('pptViewerModal').classList.add('hidden')" class="mt-4 bg-cvsu-green text-white px-6 py-2 rounded-lg font-semibold hover-cvsu transition">
              Close
            </button>
          </div>
        </div>
      `;
      showToast(message, 'error');
    }

    // Fullscreen PPT Viewer
    document.getElementById('fullscreenPPTBtn').addEventListener('click', () => {
      const modal = document.getElementById('pptViewerModal');
      
      if (!document.fullscreenElement) {
        // Enter fullscreen
        if (modal.requestFullscreen) {
          modal.requestFullscreen();
        } else if (modal.webkitRequestFullscreen) {
          modal.webkitRequestFullscreen();
        } else if (modal.msRequestFullscreen) {
          modal.msRequestFullscreen();
        }
        
        // Update button icon to exit fullscreen
        document.getElementById('fullscreenPPTBtn').innerHTML = `
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        `;
      } else {
        // Exit fullscreen
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        }
      }
    });

    // Listen for fullscreen changes to update button
    document.addEventListener('fullscreenchange', () => {
      const btn = document.getElementById('fullscreenPPTBtn');
      if (!document.fullscreenElement && btn) {
        btn.innerHTML = `
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
          </svg>
        `;
      }
    });

    // Close PPT Viewer
    document.getElementById('closePPTViewer').addEventListener('click', () => {
      // Exit fullscreen if active
      if (document.fullscreenElement) {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        }
      }
      document.getElementById('pptViewerModal').classList.add('hidden');
    });

    // Navigation buttons
    document.getElementById('pptPrevSlide').addEventListener('click', () => {
      if (currentSlideIndex > 0) {
        showSlide(currentSlideIndex - 1);
      }
    });

    document.getElementById('pptNextSlide').addEventListener('click', () => {
      if (currentSlideIndex < pptSlides.length - 1) {
        showSlide(currentSlideIndex + 1);
      }
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      const modal = document.getElementById('pptViewerModal');
      if (!modal.classList.contains('hidden')) {
        if (e.key === 'ArrowLeft') {
          document.getElementById('pptPrevSlide').click();
        } else if (e.key === 'ArrowRight') {
          document.getElementById('pptNextSlide').click();
        } else if (e.key === 'Escape') {
          modal.classList.add('hidden');
        }
      }
    });

    // Setup resource card click handlers
    function setupResourceCards() {
      document.querySelectorAll('.resource-card').forEach(card => {
        const clickHandler = (e) => {
          if (e.target.closest('.resource-download')) {
            return;
          }
          
          e.preventDefault();
          e.stopPropagation();
          
          const fileURL = card.dataset.fileUrl;
          const title = card.querySelector('h4').textContent;
          const fileType = card.querySelector('.badge').textContent.toUpperCase();
          
          if (!fileURL || fileURL === 'null' || fileURL === 'undefined' || fileURL === '') {
            showToast('This resource has no file attached yet. Please upload a file.', 'warning');
            return;
          }
          
          // Check if it's a PowerPoint file
          if (fileType === 'PPT' || fileType === 'PPTX') {
            openPPTViewer(fileURL, title);
            return;
          }
          
          // For other files, open in new tab
          try {
            const newWindow = window.open(fileURL, '_blank', 'noopener,noreferrer');
            if (newWindow) {
              showToast('Opening resource...', 'success');
            } else {
              showToast('Popup blocked. Please allow popups for this site.', 'warning');
            }
          } catch (error) {
            showToast('Failed to open resource: ' + error.message, 'error');
          }
        };
        
        card.removeEventListener('click', clickHandler);
        card.addEventListener('click', clickHandler);
      });

      document.querySelectorAll('.resource-download').forEach(btn => {
        const downloadHandler = (e) => {
          e.stopPropagation();
          e.preventDefault();
          
          const fileURL = btn.dataset.fileUrl;
          const fileName = btn.dataset.fileName || 'download';
          
          if (!fileURL || fileURL === 'null' || fileURL === 'undefined' || fileURL === '') {
            showToast('This resource has no file attached yet.', 'warning');
            return;
          }
          
          try {
            fetch(fileURL)
              .then(response => response.blob())
              .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                showToast('Download started!', 'success');
              })
              .catch(() => {
                const link = document.createElement('a');
                link.href = fileURL;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                link.download = fileName;
                link.click();
                showToast('Opening download...', 'success');
              });
          } catch (error) {
            showToast('Download failed: ' + error.message, 'error');
          }
        };
        
        btn.removeEventListener('click', downloadHandler);
        btn.addEventListener('click', downloadHandler);
      });
    }

    // Setup profile page
    function setupProfilePage() {
      const editBtn = document.getElementById('editProfileBtn');
      if (editBtn) {
        editBtn.addEventListener('click', () => {
          showEditProfileModal();
        });
      }

      // Load banner if exists
      const bannerContainer = document.getElementById('bannerContainer');
      if (bannerContainer) {
        database.ref('users/' + currentUser.uid + '/bannerURL').once('value').then(snapshot => {
          if (snapshot.exists()) {
            const bannerURL = snapshot.val();
            bannerContainer.style.backgroundImage = `url(${bannerURL})`;
            bannerContainer.style.backgroundSize = 'cover';
            bannerContainer.style.backgroundPosition = 'center';
          }
        });
      }
    }

    // Show Edit Profile Modal
    function showEditProfileModal() {
      const modal = document.createElement('div');
      modal.id = 'editProfileModal';
      modal.className = 'fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full p-8 fade-in max-h-[90vh] overflow-y-auto">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-cvsu-green">Edit Profile</h2>
            <button id="closeEditModal" class="text-gray-400 hover:text-gray-600 transition">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <form id="editProfileForm" class="space-y-6">
            <div>
              <label for="editDisplayName" class="block text-sm font-semibold text-gray-700 mb-2">Display Name</label>
              <input type="text" id="editDisplayName" value="${currentUser.displayName || ''}" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cvsu-green focus:border-transparent smooth-transition" placeholder="Your display name">
            </div>

            <div>
              <label for="editBio" class="block text-sm font-semibold text-gray-700 mb-2">Bio</label>
              <textarea id="editBio" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cvsu-green focus:border-transparent smooth-transition" placeholder="Tell us about yourself...">${userData.bio || ''}</textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="editCourse" class="block text-sm font-semibold text-gray-700 mb-2">Course</label>
                <input type="text" id="editCourse" value="${userData.course || ''}" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cvsu-green focus:border-transparent smooth-transition" placeholder="e.g., BS Computer Science">
              </div>

              <div>
                <label for="editYearLevel" class="block text-sm font-semibold text-gray-700 mb-2">Year Level</label>
                <select id="editYearLevel" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cvsu-green focus:border-transparent smooth-transition">
                  <option value="">Select Year Level</option>
                  <option value="1st Year" ${userData.yearLevel === '1st Year' ? 'selected' : ''}>1st Year</option>
                  <option value="2nd Year" ${userData.yearLevel === '2nd Year' ? 'selected' : ''}>2nd Year</option>
                  <option value="3rd Year" ${userData.yearLevel === '3rd Year' ? 'selected' : ''}>3rd Year</option>
                  <option value="4th Year" ${userData.yearLevel === '4th Year' ? 'selected' : ''}>4th Year</option>
                  <option value="Graduate" ${userData.yearLevel === 'Graduate' ? 'selected' : ''}>Graduate</option>
                </select>
              </div>
            </div>

            <div class="flex gap-4 pt-4">
              <button type="button" id="cancelEdit" class="flex-1 px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50 smooth-transition">
                Cancel
              </button>
              <button type="submit" class="flex-1 bg-cvsu-green text-white px-6 py-3 rounded-lg font-semibold hover-cvsu smooth-transition">
                Save Changes
              </button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);

      // Close modal handlers
      document.getElementById('closeEditModal').addEventListener('click', () => {
        modal.remove();
      });

      document.getElementById('cancelEdit').addEventListener('click', () => {
        modal.remove();
      });

      // Form submission
      document.getElementById('editProfileForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const displayName = document.getElementById('editDisplayName').value.trim();
        const bio = document.getElementById('editBio').value.trim();
        const course = document.getElementById('editCourse').value.trim();
        const yearLevel = document.getElementById('editYearLevel').value;

        if (!displayName) {
          showToast('Please enter a display name', 'error');
          return;
        }

        showToast('Saving changes...', 'info');

        try {
          // Update Firebase Auth profile
          await currentUser.updateProfile({ displayName });

          // Update Firebase Database
          await database.ref('users/' + currentUser.uid).update({
            name: displayName,
            bio: bio || 'New member of Resource ClassHub',
            course: course,
            yearLevel: yearLevel
          });

          // Update local userData
          userData.bio = bio || 'New member of Resource ClassHub';
          userData.course = course;
          userData.yearLevel = yearLevel;

          // Update UI
          document.getElementById('navUserName').textContent = displayName;
          
          showToast('Profile updated successfully!', 'success');
          modal.remove();
          
          // Reload profile page to show changes
          loadPage('profile');
        } catch (error) {
          console.error('Profile update error:', error);
          showToast('Failed to update profile: ' + error.message, 'error');
        }
      });
    }

    // Setup upload page
    function setupUploadPage() {
      const dropZone = document.getElementById('dropZone');
      const fileInput = document.getElementById('fileInput');
      const uploadForm = document.getElementById('uploadForm');

      if (!dropZone || !fileInput || !uploadForm) return;

      dropZone.addEventListener('click', () => {
        fileInput.click();
      });

      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('drag-over');
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        const files = e.dataTransfer.files;
        fileInput.files = files;
        handleFiles(files);
      });

      fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
      });

      uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        await handleUpload(uploadForm);
      });
    }

    function handleFiles(files) {
      const fileListDiv = document.getElementById('selectedFilesList');
      if (!fileListDiv) return;

      if (files.length > 0) {
        fileListDiv.innerHTML = '';
        Array.from(files).forEach(file => {
          const fileItem = document.createElement('div');
          fileItem.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
          fileItem.innerHTML = `
            <div class="flex items-center gap-3">
              <svg class="w-8 h-8 text-cvsu-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <div>
                <p class="font-semibold text-gray-800">${file.name}</p>
                <p class="text-sm text-gray-500">${formatFileSize(file.size)}</p>
              </div>
            </div>
            <button type="button" onclick="clearSelectedFiles()" class="text-red-600 hover:text-red-800">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          `;
          fileListDiv.appendChild(fileItem);
        });
        fileListDiv.classList.remove('hidden');
        showToast(`${files.length} file(s) selected`, 'success');
      }
    }

    function clearSelectedFiles() {
      const fileInput = document.getElementById('fileInput');
      const fileListDiv = document.getElementById('selectedFilesList');
      if (fileInput) fileInput.value = '';
      if (fileListDiv) {
        fileListDiv.innerHTML = '';
        fileListDiv.classList.add('hidden');
      }
    }

    async function handleUpload(form) {
      const title = document.getElementById('uploadTitle').value.trim();
      const description = document.getElementById('uploadDescription').value.trim();
      const category = document.getElementById('uploadCategory').value;
      const courseCode = document.getElementById('uploadCourse').value.trim();
      const tags = document.getElementById('uploadTags').value.trim();
      const visibility = form.querySelector('input[name="visibility"]:checked').value;
      const fileInput = document.getElementById('fileInput');
      const files = fileInput.files;

      if (!title || files.length === 0) {
        showToast('Please provide a title and select a file', 'error');
        return;
      }

      const file = files[0];
      const maxSize = 50 * 1024 * 1024; // 50MB
      if (file.size > maxSize) {
        showToast('File too large. Maximum size is 50MB', 'error');
        return;
      }

      showToast('Uploading to cloud storage...', 'info');

      try {
        // Upload to Firebase Storage first
        const storageRef = storage.ref(`resources/${currentUser.uid}/${Date.now()}_${file.name}`);
        const uploadTask = await storageRef.put(file);
        const downloadURL = await uploadTask.ref.getDownloadURL();

        // Verify URL is valid
        if (!downloadURL || downloadURL === 'undefined' || downloadURL === 'null') {
          throw new Error('Failed to get valid download URL');
        }

        console.log('File uploaded successfully. URL:', downloadURL);

        // Save metadata to Firebase database
        const resourceData = {
          title,
          description: description || 'No description provided',
          category,
          course: courseCode || 'General',
          tags: tags ? tags.split(',').map(t => t.trim()) : [],
          visibility,
          author: currentUser.displayName || 'Anonymous',
          authorId: currentUser.uid,
          fileURL: downloadURL,
          fileName: file.name,
          fileSize: formatFileSize(file.size),
          fileType: file.name.split('.').pop().toUpperCase(),
          uploadDate: Date.now(),
          views: 0
        };

        const newResourceRef = await database.ref('resources').push(resourceData);
        console.log('Resource saved to database:', newResourceRef.key);
        
        showToast('Upload successful!', 'success');
        form.reset();
        clearSelectedFiles();
        
        // Reload data and navigate to appropriate library
        await loadAllData();
        
        const fileType = resourceData.fileType;
        if (fileType === 'PPT' || fileType === 'PPTX') {
          loadPage('ppt');
        } else {
          loadPage('notes');
        }
      } catch (error) {
        console.error('Upload error:', error);
        showToast('Upload failed: ' + error.message, 'error');
      }
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // Setup library page
    function setupLibraryPage(type) {
      const filterButtons = document.querySelectorAll('.filter-btn');
      filterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          filterButtons.forEach(b => {
            b.classList.remove('bg-cvsu-green', 'text-white');
            b.classList.add('bg-gray-200', 'text-gray-700');
          });
          btn.classList.remove('bg-gray-200', 'text-gray-700');
          btn.classList.add('bg-cvsu-green', 'text-white');
          
          const category = btn.textContent.trim();
          filterResources(type, category);
        });
      });
    }

    function filterResources(type, category) {
      let filtered = allResources;
      
      if (type === 'notes') {
        filtered = filtered.filter(r => r.fileType === 'PDF' || r.fileType === 'DOC' || r.fileType === 'DOCX');
      } else if (type === 'ppt') {
        filtered = filtered.filter(r => r.fileType === 'PPT' || r.fileType === 'PPTX');
      }
      
      if (category !== 'All') {
        filtered = filtered.filter(r => r.category === category);
      }
      
      showToast(`Showing ${filtered.length} resources`, 'info');
    }

    // Setup settings page
    function setupSettingsPage() {
      const saveBtn = document.querySelector('.settings-save-btn');
      if (saveBtn) {
        saveBtn.addEventListener('click', async () => {
          const displayName = document.getElementById('settingsName').value.trim();
          
          if (!displayName) {
            showToast('Please enter a display name', 'error');
            return;
          }

          // Show loading state
          saveBtn.disabled = true;
          saveBtn.innerHTML = `
            <div class="flex items-center justify-center gap-2">
              <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
              Saving...
            </div>
          `;
          
          try {
            await currentUser.updateProfile({ displayName });
            await database.ref('users/' + currentUser.uid).update({ name: displayName });
            
            document.getElementById('navUserName').textContent = displayName;
            showToast('Settings saved successfully!', 'success');
            
            // Reset button
            saveBtn.innerHTML = 'Save Changes';
            saveBtn.disabled = false;
          } catch (error) {
            console.error('Settings save error:', error);
            showToast('Failed to save settings: ' + error.message, 'error');
            
            // Reset button
            saveBtn.innerHTML = 'Save Changes';
            saveBtn.disabled = false;
          }
        });
      }
    }

    // Page content generator
    function getPageContent(pageName) {
      switch(pageName) {
        case 'dashboard':
          return getDashboardContent();
        case 'notes':
          return getNotesContent();
        case 'ppt':
          return getPPTContent();
        case 'upload':
          return getUploadContent();
        case 'classes':
          return getClassesContent();
        case 'assignments':
          return getAssignmentsContent();
        case 'announcements':
          return getAnnouncementsContent();
        case 'forums':
          return getForumsContent();
        case 'calendar':
          return getCalendarContent();
        case 'profile':
          return getProfileContent();
        case 'settings':
          return getSettingsContent();
        case 'admin':
          return getAdminContent();
        default:
          return getDashboardContent();
      }
    }

    // Dashboard Page
    function getDashboardContent() {
      const resourceCount = allResources.length;
      const classCount = allClasses.length;
      const pendingAssignments = allAssignments.filter(a => !a.completed).length;
      
      return `
        <div class="fade-in">
          <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Welcome back, ${currentUser.displayName || 'User'}!</h2>
            <p class="text-gray-600">Your role: <span class="inline-block px-3 py-1 bg-cvsu-green text-white rounded-full text-sm font-semibold">${currentUserRole.toUpperCase()}</span></p>
          </div>

          <!-- Quick Stats -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow card-hover">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 text-sm font-semibold">Total Resources</p>
                  <p class="text-3xl font-bold text-cvsu-green mt-2">${resourceCount}</p>
                </div>
                <svg class="w-12 h-12 text-cvsu-green opacity-20" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9 2a2 2 0 00-2 2v8a2 2 0 002 2h6a2 2 0 002-2V6.414A2 2 0 0016.414 5L14 2.586A2 2 0 0012.586 2H9z"/>
                </svg>
              </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow card-hover">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 text-sm font-semibold">My Classes</p>
                  <p class="text-3xl font-bold text-cvsu-green mt-2">${classCount}</p>
                </div>
                <svg class="w-12 h-12 text-cvsu-green opacity-20" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"/>
                </svg>
              </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow card-hover">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 text-sm font-semibold">Pending Tasks</p>
                  <p class="text-3xl font-bold text-cvsu-green mt-2">${pendingAssignments}</p>
                </div>
                <svg class="w-12 h-12 text-cvsu-green opacity-20" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                </svg>
              </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow card-hover">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 text-sm font-semibold">Total XP</p>
                  <p class="text-3xl font-bold text-cvsu-green mt-2">${userData.totalXP}</p>
                </div>
                <svg class="w-12 h-12 text-cvsu-green opacity-20" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
              </div>
            </div>
          </div>

          <!-- Recent Activity & Announcements -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Recent Uploads -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <svg class="w-6 h-6 text-cvsu-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Recent Uploads
              </h3>
              <div class="space-y-4">
                ${allResources.slice(0, 3).map(resource => `
                  <div class="flex items-start gap-3 p-3 hover:bg-gray-50 rounded-lg transition cursor-pointer resource-card" data-resource-id="${resource.id}" data-file-url="${resource.fileURL || ''}" onclick="handleResourceClick('${resource.fileURL || ''}', '${resource.title}', '${resource.fileType}')">
                    <div class="w-12 h-12 bg-cvsu-green rounded-lg flex items-center justify-center flex-shrink-0">
                      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                      </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                      <p class="font-semibold text-gray-800 truncate">${resource.title}</p>
                      <p class="text-sm text-gray-500">By ${resource.author} • ${getTimeAgo(resource.uploadDate)}</p>
                      <div class="flex gap-2 mt-1">
                        <span class="badge bg-blue-100 text-blue-700">${resource.fileType}</span>
                        <span class="badge bg-purple-100 text-purple-700">${resource.course}</span>
                      </div>
                    </div>
                  </div>
                `).join('') || '<p class="text-gray-500 text-center py-4">No resources yet</p>'}
              </div>
            </div>

            <!-- Announcements -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <svg class="w-6 h-6 text-cvsu-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/>
                </svg>
                Latest Announcements
              </h3>
              <div class="space-y-4">
                ${allAnnouncements.slice(0, 3).map(announcement => `
                  <div class="border-l-4 border-cvsu-green p-4 bg-gray-50 rounded">
                    <div class="flex items-start justify-between">
                      <div class="flex-1">
                        <p class="font-semibold text-gray-800">${announcement.title}</p>
                        <p class="text-sm text-gray-600 mt-1">${announcement.content}</p>
                        <p class="text-xs text-gray-500 mt-2">${getTimeAgo(announcement.date)}</p>
                      </div>
                      <span class="ml-2 px-2 py-1 bg-red-100 text-red-700 text-xs font-semibold rounded">${announcement.category}</span>
                    </div>
                  </div>
                `).join('') || '<p class="text-gray-500 text-center py-4">No announcements yet</p>'}
              </div>
            </div>
          </div>

          <!-- Upcoming Deadlines -->
          <div class="bg-white rounded-lg shadow p-6 mt-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
              <svg class="w-6 h-6 text-cvsu-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              Upcoming Deadlines
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              ${allAssignments.filter(a => !a.completed).slice(0, 3).map((assignment, index) => {
                const colors = ['red', 'yellow', 'green'];
                const dueDays = ['Tomorrow', '3 days', '1 week'];
                return `
                  <div class="border-2 border-${colors[index]}-200 rounded-lg p-4 bg-${colors[index]}-50">
                    <p class="text-sm font-semibold text-${colors[index]}-600 mb-1">Due ${dueDays[index]}</p>
                    <p class="font-bold text-gray-800">${assignment.title}</p>
                    <p class="text-sm text-gray-600 mt-1">${assignment.course} - ${assignment.type}</p>
                  </div>
                `;
              }).join('') || '<p class="text-gray-500 text-center py-4 col-span-3">No upcoming deadlines</p>'}
            </div>
          </div>
        </div>
      `;
    }

    // Notes Library Page
    function getNotesContent() {
      const noteResources = allResources.filter(r => 
        r.fileType === 'PDF' || r.fileType === 'DOC' || r.fileType === 'DOCX'
      );

      return `
        <div class="fade-in">
          <div class="mb-6 flex items-center justify-between">
            <h2 class="text-3xl font-bold text-gray-800">Notes Library</h2>
          </div>

          <!-- Filter Tags -->
          <div class="mb-6 flex flex-wrap gap-2">
            <button class="filter-btn px-4 py-2 bg-cvsu-green text-white rounded-full text-sm font-semibold hover-cvsu transition">All</button>
            <button class="filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-sm font-semibold hover:bg-gray-300 transition">Computer Science</button>
            <button class="filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-sm font-semibold hover:bg-gray-300 transition">Mathematics</button>
            <button class="filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-sm font-semibold hover:bg-gray-300 transition">Physics</button>
            <button class="filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-sm font-semibold hover:bg-gray-300 transition">Engineering</button>
          </div>

          <!-- Resources Grid -->
          <div class="resource-grid">
            ${noteResources.map(resource => generateResourceCard(
              resource.title,
              resource.author,
              resource.fileType,
              resource.course,
              resource.fileSize,
              `${resource.views} views`,
              false,
              resource.id,
              resource.fileURL
            )).join('') || '<p class="text-gray-500 text-center py-8 col-span-full">No notes available yet</p>'}
          </div>
        </div>
      `;
    }

    // PPT Library Page
    function getPPTContent() {
      const pptResources = allResources.filter(r => 
        r.fileType === 'PPT' || r.fileType === 'PPTX'
      );

      return `
        <div class="fade-in">
          <div class="mb-6 flex items-center justify-between">
            <h2 class="text-3xl font-bold text-gray-800">PowerPoint Library</h2>
          </div>

          <!-- Filter Tags -->
          <div class="mb-6 flex flex-wrap gap-2">
            <button class="filter-btn px-4 py-2 bg-cvsu-green text-white rounded-full text-sm font-semibold hover-cvsu transition">All</button>
            <button class="filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-sm font-semibold hover:bg-gray-300 transition">Computer Science</button>
            <button class="filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-sm font-semibold hover:bg-gray-300 transition">Mathematics</button>
            <button class="filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-sm font-semibold hover:bg-gray-300 transition">Physics</button>
            <button class="filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-sm font-semibold hover:bg-gray-300 transition">Engineering</button>
          </div>

          <!-- Resources Grid -->
          <div class="resource-grid">
            ${pptResources.map(resource => generateResourceCard(
              resource.title,
              resource.author,
              resource.fileType,
              resource.course,
              resource.fileSize,
              `${resource.views} views`,
              true,
              resource.id,
              resource.fileURL
            )).join('') || '<p class="text-gray-500 text-center py-8 col-span-full">No presentations available yet</p>'}
          </div>
        </div>
      `;
    }

    // Upload Page
    function getUploadContent() {
      const canUpload = ['teacher', 'aa_member', 'officer', 'director'].includes(currentUserRole);

      if (!canUpload) {
        return `
          <div class="fade-in max-w-4xl mx-auto">
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-6 rounded-lg">
              <div class="flex items-center gap-3">
                <svg class="w-8 h-8 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                <div>
                  <h3 class="text-lg font-bold text-gray-800">Upload Permission Required</h3>
                  <p class="text-gray-700 mt-1">You need teacher or member privileges to upload resources. Please contact an administrator.</p>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      return `
        <div class="fade-in max-w-4xl mx-auto">
          <h2 class="text-3xl font-bold text-gray-800 mb-6">Upload Resources</h2>

          <div class="bg-white rounded-lg shadow p-8">
            <!-- Drag and Drop Zone -->
            <div class="upload-zone rounded-lg p-12 text-center mb-6 cursor-pointer" id="dropZone">
              <svg class="w-16 h-16 text-cvsu-green mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
              </svg>
              <h3 class="text-xl font-bold text-gray-800 mb-2">Drag & Drop Files Here</h3>
              <p class="text-gray-600 mb-4">or click to browse</p>
              <input type="file" id="fileInput" class="hidden" accept=".pdf,.ppt,.pptx,.doc,.docx">
              <button type="button" onclick="event.stopPropagation(); document.getElementById('fileInput').click()" class="bg-cvsu-green text-white px-6 py-3 rounded-lg font-semibold hover-cvsu transition">
                Select Files
              </button>
              <p class="text-sm text-gray-500 mt-4">Supported formats: PDF, PPT, PPTX, DOC, DOCX (Max 50MB)</p>
            </div>

            <!-- Selected Files Display -->
            <div id="selectedFilesList" class="hidden mb-6 space-y-2">
              <!-- Files will be displayed here -->
            </div>

            <!-- Upload Form -->
            <form id="uploadForm" class="space-y-6">
              <div>
                <label for="uploadTitle" class="block text-sm font-semibold text-gray-700 mb-2">Title</label>
                <input type="text" id="uploadTitle" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cvsu-green focus:border-transparent" placeholder="Enter resource title">
              </div>

              <div>
                <label for="uploadDescription" class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                <textarea id="uploadDescription" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cvsu-green focus:border-transparent" placeholder="Describe this resource..."></textarea>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label for="uploadCategory" class="block text-sm font-semibold text-gray-700 mb-2">Category</label>
                  <select id="uploadCategory" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cvsu-green focus:border-transparent">
                    <option>Computer Science</option>
                    <option>Mathematics</option>
                    <option>Physics</option>
                    <option>Chemistry</option>
                    <option>Engineering</option>
                    <option>Other</option>
                  </select>
                </div>

                <div>
                  <label for="uploadCourse" class="block text-sm font-semibold text-gray-700 mb-2">Course Code</label>
                  <input type="text" id="uploadCourse" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cvsu-green focus:border-transparent" placeholder="e.g., CS101">
                </div>
              </div>

              <div>
                <label for="uploadTags" class="block text-sm font-semibold text-gray-700 mb-2">Tags</label>
                <input type="text" id="uploadTags" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cvsu-green focus:border-transparent" placeholder="Add tags separated by commas">
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Visibility</label>
                <div class="space-y-2">
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="visibility" value="public" checked class="text-cvsu-green focus:ring-cvsu-green">
                    <span class="text-gray-700">Public - Everyone can view</span>
                  </label>
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="visibility" value="members" class="text-cvsu-green focus:ring-cvsu-green">
                    <span class="text-gray-700">Members Only</span>
                  </label>
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="visibility" value="officers" class="text-cvsu-green focus:ring-cvsu-green">
                    <span class="text-gray-700">Officers Only</span>
                  </label>
                </div>
              </div>

              <div class="flex gap-4">
                <button type="submit" class="flex-1 bg-cvsu-green text-white px-6 py-3 rounded-lg font-semibold hover-cvsu transition">
                  Upload Resource
                </button>
              </div>
            </form>
          </div>
        </div>
      `;
    }

    // Classes Page
    function getClassesContent() {
      return `
        <div class="fade-in">
          <div class="mb-6 flex items-center justify-between">
            <h2 class="text-3xl font-bold text-gray-800">My Classes</h2>
            ${['teacher', 'officer', 'director'].includes(currentUserRole) ? `
              <button class="bg-cvsu-green text-white px-6 py-2 rounded-lg font-semibold hover-cvsu transition flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Create Class
              </button>
            ` : ''}
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            ${allClasses.map(cls => generateClassCard(
              cls.name,
              cls.teacher,
              `${cls.students} students`,
              cls.code
            )).join('') || '<p class="text-gray-500 text-center py-8 col-span-full">No classes available yet</p>'}
          </div>
        </div>
      `;
    }

    // Assignments Page
    function getAssignmentsContent() {
      const pending = allAssignments.filter(a => !a.completed);
      const completed = allAssignments.filter(a => a.completed);

      return `
        <div class="fade-in">
          <h2 class="text-3xl font-bold text-gray-800 mb-6">Assignments</h2>

          <!-- Pending Assignments -->
          <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
              <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              Pending Submissions
            </h3>
            <div class="space-y-4">
              ${pending.map((assignment, index) => {
                const urgencies = ['urgent', 'warning', 'normal'];
                return generateAssignmentCard(
                  assignment.title,
                  assignment.course,
                  assignment.deadline,
                  urgencies[index % 3]
                );
              }).join('') || '<p class="text-gray-500 text-center py-4">No pending assignments</p>'}
            </div>
          </div>

          <!-- Completed Assignments -->
          <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
              <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              Completed
            </h3>
            <div class="space-y-4">
              ${completed.map(assignment => generateAssignmentCard(
                assignment.title,
                assignment.course,
                'Submitted',
                'completed',
                assignment.grade || '95/100'
              )).join('') || '<p class="text-gray-500 text-center py-4">No completed assignments yet</p>'}
            </div>
          </div>
        </div>
      `;
    }

    // Announcements Page
    function getAnnouncementsContent() {
      return `
        <div class="fade-in">
          <div class="mb-6 flex items-center justify-between">
            <h2 class="text-3xl font-bold text-gray-800">Announcements</h2>
            ${['teacher', 'officer', 'director'].includes(currentUserRole) ? `
              <button class="bg-cvsu-green text-white px-6 py-2 rounded-lg font-semibold hover-cvsu transition flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                New Announcement
              </button>
            ` : ''}
          </div>

          <div class="space-y-4">
            ${allAnnouncements.map((announcement, index) => generateAnnouncementCard(
              announcement.title,
              announcement.content,
              announcement.category,
              ['red', 'blue', 'green', 'yellow', 'purple'][index % 5],
              getTimeAgo(announcement.date),
              index === 0
            )).join('') || '<p class="text-gray-500 text-center py-8">No announcements yet</p>'}
          </div>
        </div>
      `;
    }

    // Forums Page
    function getForumsContent() {
      return `
        <div class="fade-in">
          <div class="mb-6 flex items-center justify-between">
            <h2 class="text-3xl font-bold text-gray-800">Discussion Forums</h2>
            <button onclick="showCreateTopicModal()" class="bg-cvsu-green text-white px-6 py-2 rounded-lg font-semibold hover-cvsu transition flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
              New Topic
            </button>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            ${generateForumRoom('💻', 'Computer Science', '234 topics', '1.2k posts')}
            ${generateForumRoom('📐', 'Mathematics', '156 topics', '890 posts')}
            ${generateForumRoom('⚡', 'Physics', '98 topics', '567 posts')}
            ${generateForumRoom('🧪', 'Chemistry', '87 topics', '423 posts')}
            ${generateForumRoom('���', 'General Discussion', '312 topics', '2.1k posts')}
            ${generateForumRoom('❓', 'Questions & Answers', '445 topics', '3.4k posts')}
          </div>

          <!-- Recent Discussions -->
          <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200">
              <h3 class="text-xl font-bold text-gray-800">Recent Discussions</h3>
            </div>
            <div class="divide-y divide-gray-200">
              ${allForumTopics.length > 0 ? allForumTopics.map(topic => `
                <div onclick="openForumTopic('${topic.id}')" class="p-5 hover:bg-gray-50 cursor-pointer transition">
                  <div class="flex items-start justify-between">
                    <div class="flex-1">
                      <h4 class="font-semibold text-gray-800 mb-1">${topic.title}</h4>
                      <div class="flex items-center gap-3 text-sm text-gray-600">
                        <span>By ${topic.author}</span>
                        <span>•</span>
                        <span class="badge bg-gray-100 text-gray-700">${topic.category}</span>
                        <span>•</span>
                        <span>${topic.replies || 0} replies</span>
                      </div>
                    </div>
                    <span class="text-sm text-gray-500">${getTimeAgo(topic.date)}</span>
                  </div>
                </div>
              `).join('') : '<p class="text-gray-500 text-center py-8">No forum topics yet. Click "New Topic" to start a discussion!</p>'}
            </div>
          </div>
        </div>
      `;
    }

    // Calendar Page
    function getCalendarContent() {
      const today = new Date();
      const currentMonth = today.toLocaleString('default', { month: 'long' });
      const currentYear = today.getFullYear();
      const daysInMonth = new Date(currentYear, today.getMonth() + 1, 0).getDate();

      return `
        <div class="fade-in">
          <h2 class="text-3xl font-bold text-gray-800 mb-6">Academic Calendar</h2>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Calendar -->
            <div class="lg:col-span-2 bg-white rounded-lg shadow p-6">
              <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-gray-800">${currentMonth} ${currentYear}</h3>
                <div class="flex gap-2">
                  <button class="p-2 hover:bg-gray-100 rounded-lg transition">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                  </button>
                  <button class="p-2 hover:bg-gray-100 rounded-lg transition">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                  </button>
                </div>
              </div>

              <!-- Calendar Grid -->
              <div class="grid grid-cols-7 gap-2">
                ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => `
                  <div class="text-center font-semibold text-gray-600 py-2">${day}</div>
                `).join('')}
                ${Array.from({length: daysInMonth}, (_, i) => i + 1).map(day => `
                  <div class="aspect-square p-2 text-center rounded-lg hover:bg-gray-100 cursor-pointer transition ${day === today.getDate() ? 'bg-cvsu-green text-white font-bold' : ''}">
                    ${day}
                  </div>
                `).join('')}
              </div>
            </div>

            <!-- Upcoming Events -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="text-xl font-bold text-gray-800 mb-4">Upcoming Events</h3>
              <div class="space-y-4">
                ${allAssignments.slice(0, 4).map((assignment, index) => {
                  const colors = ['red', 'blue', 'green', 'purple'];
                  return `
                    <div class="border-l-4 border-${colors[index]}-500 pl-4 py-2">
                      <p class="font-semibold text-gray-800">${assignment.title}</p>
                      <p class="text-sm text-gray-600">${assignment.deadline}</p>
                    </div>
                  `;
                }).join('') || '<p class="text-gray-500 text-center py-4">No upcoming events</p>'}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Profile Page
    function getProfileContent() {
      return `
        <div class="fade-in">
          <!-- Profile Banner -->
          <div class="profile-banner rounded-t-lg relative mb-20" id="bannerContainer">
            <div class="absolute -bottom-16 left-8">
              <div class="relative">
                <img id="profilePicImg" src="${currentUser.photoURL || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23006400"%3E%3Cpath d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/%3E%3C/svg%3E'}" alt="Profile" class="w-32 h-32 rounded-full border-4 border-white bg-white object-cover">
              </div>
            </div>
          </div>

          <!-- Profile Info -->
          <div class="bg-white rounded-b-lg shadow p-8 mb-6">
            <div class="flex items-start justify-between">
              <div>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">${currentUser.displayName || 'User'}</h2>
                <p class="text-gray-600 mb-2">${currentUser.email}</p>
                <div class="flex items-center gap-2 mb-4">
                  <span class="px-3 py-1 bg-cvsu-green text-white rounded-full text-sm font-semibold">${currentUserRole.toUpperCase()}</span>
                  ${userData.course ? `<span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-semibold">${userData.course}</span>` : ''}
                  ${userData.yearLevel ? `<span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-semibold">${userData.yearLevel}</span>` : ''}
                </div>
                <p class="text-gray-700 max-w-2xl">${userData.bio || 'New member of Resource ClassHub'}</p>
              </div>
              <button id="editProfileBtn" class="bg-cvsu-green text-white px-6 py-2 rounded-lg font-semibold hover-cvsu transition flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                Edit Profile
              </button>
            </div>
          </div>

          <!-- Stats & Activity -->
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Stats -->
            <div class="lg:col-span-1">
              <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Stats</h3>
                <div class="space-y-4">
                  <div class="flex items-center justify-between">
                    <span class="text-gray-600">Total XP</span>
                    <span class="font-bold text-cvsu-green">${userData.totalXP}</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="text-gray-600">Resources Viewed</span>
                    <span class="font-bold text-cvsu-green">${userData.resourcesViewed}</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="text-gray-600">Assignments Done</span>
                    <span class="font-bold text-cvsu-green">${userData.assignmentsDone}</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="text-gray-600">Forum Posts</span>
                    <span class="font-bold text-cvsu-green">${userData.forumPosts}</span>
                  </div>
                </div>
              </div>

              <!-- Badges -->
              <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Badges</h3>
                ${userData.badges && userData.badges.length > 0 ? `
                  <div class="grid grid-cols-3 gap-3">
                    ${userData.badges.map(badge => `
                      <div class="text-center">
                        <div class="w-16 h-16 mx-auto bg-${badge.color || 'yellow'}-100 rounded-full flex items-center justify-center mb-2">
                          <span class="text-3xl">${badge.icon || '🏆'}</span>
                        </div>
                        <p class="text-xs text-gray-600">${badge.name || 'Badge'}</p>
                      </div>
                    `).join('')}
                  </div>
                ` : `
                  <div class="text-center py-4">
                    <p class="text-gray-500">No badges earned yet</p>
                    <p class="text-xs text-gray-400 mt-1">Complete activities to earn badges!</p>
                  </div>
                `}
              </div>
            </div>

            <!-- Activity Timeline -->
            <div class="lg:col-span-2">
              <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Recent Activity</h3>
                ${userData.activityTimeline && userData.activityTimeline.length > 0 ? `
                  <div class="space-y-6">
                    ${userData.activityTimeline.slice(0, 10).map((activity, index) => {
                      const colors = ['cvsu-green', 'blue-500', 'purple-500', 'green-500', 'yellow-500'];
                      const color = colors[index % colors.length];
                      return `
                        <div class="flex gap-4">
                          <div class="flex-shrink-0 w-2 bg-${color} rounded-full"></div>
                          <div class="flex-1">
                            <p class="font-semibold text-gray-800">${activity.action || 'Activity'}</p>
                            <p class="text-sm text-gray-600">${activity.description || ''}</p>
                            <p class="text-xs text-gray-500 mt-1">${getTimeAgo(activity.timestamp || Date.now())}</p>
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                ` : `
                  <div class="text-center py-8">
                    <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p class="text-gray-500 font-semibold">No activity yet</p>
                    <p class="text-sm text-gray-400 mt-1">Start using Resource ClassHub to see your activity here!</p>
                  </div>
                `}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Admin Page
    function getAdminContent() {
      // Check authorization
      if (currentUserRole !== 'teacher' && currentUserRole !== 'director') {
        return `
          <div class="fade-in max-w-4xl mx-auto">
            <div class="bg-red-50 border-l-4 border-red-400 p-6 rounded-lg">
              <div class="flex items-center gap-3">
                <svg class="w-8 h-8 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
                <div>
                  <h3 class="text-lg font-bold text-gray-800">Access Denied</h3>
                  <p class="text-gray-700 mt-1">You need teacher or director privileges to access the admin panel.</p>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      return `
        <div class="fade-in">
          <div class="mb-6 flex items-center justify-between">
            <h2 class="text-3xl font-bold text-gray-800">Admin Panel</h2>
            <span class="px-4 py-2 bg-red-100 text-red-700 rounded-full text-sm font-bold">
              ${currentUserRole.toUpperCase()} ACCESS
            </span>
          </div>

          <!-- Quick Actions -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <button onclick="showCreateResourceModal()" class="bg-white p-6 rounded-lg shadow card-hover text-left">
              <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mb-4">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
              </div>
              <h3 class="font-bold text-gray-800 mb-2">Add Resource</h3>
              <p class="text-sm text-gray-600">Upload new learning materials</p>
            </button>

            <button onclick="showCreateAnnouncementModal()" class="bg-white p-6 rounded-lg shadow card-hover text-left">
              <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mb-4">
                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/>
                </svg>
              </div>
              <h3 class="font-bold text-gray-800 mb-2">Make Announcement</h3>
              <p class="text-sm text-gray-600">Post important updates</p>
            </button>

            <button onclick="showCreateClassModal()" class="bg-white p-6 rounded-lg shadow card-hover text-left">
              <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mb-4">
                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                </svg>
              </div>
              <h3 class="font-bold text-gray-800 mb-2">Create Class</h3>
              <p class="text-sm text-gray-600">Set up new class sections</p>
            </button>
          </div>

          <!-- Platform Statistics -->
          <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Platform Statistics</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
              <div class="text-center">
                <p class="text-3xl font-bold text-cvsu-green mb-1">${allResources.length}</p>
                <p class="text-sm text-gray-600">Total Resources</p>
              </div>
              <div class="text-center">
                <p class="text-3xl font-bold text-blue-600 mb-1">${allClasses.length}</p>
                <p class="text-sm text-gray-600">Active Classes</p>
              </div>
              <div class="text-center">
                <p class="text-3xl font-bold text-purple-600 mb-1">${allAssignments.length}</p>
                <p class="text-sm text-gray-600">Assignments</p>
              </div>
              <div class="text-center">
                <p class="text-3xl font-bold text-green-600 mb-1">${allForumTopics.length}</p>
                <p class="text-sm text-gray-600">Forum Topics</p>
              </div>
            </div>
          </div>

          <!-- Recent Resources -->
          <div class="bg-white rounded-lg shadow mb-6">
            <div class="p-6 border-b border-gray-200 flex items-center justify-between">
              <h3 class="text-xl font-bold text-gray-800">Recent Resources</h3>
              <button onclick="loadPage('upload')" class="text-cvsu-green hover:underline font-semibold text-sm">View All</button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Title</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Author</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Type</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Date</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                  ${allResources.slice(0, 5).map(resource => `
                    <tr class="hover:bg-gray-50">
                      <td class="px-6 py-4 text-sm text-gray-800">${resource.title}</td>
                      <td class="px-6 py-4 text-sm text-gray-600">${resource.author}</td>
                      <td class="px-6 py-4 text-sm">
                        <span class="badge bg-blue-100 text-blue-700">${resource.fileType}</span>
                      </td>
                      <td class="px-6 py-4 text-sm text-gray-600">${getTimeAgo(resource.uploadDate)}</td>
                      <td class="px-6 py-4 text-sm">
                        <button onclick="deleteResource('${resource.id}')" class="text-red-600 hover:text-red-800 font-semibold">Delete</button>
                      </td>
                    </tr>
                  `).join('') || '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">No resources yet</td></tr>'}
                </tbody>
              </table>
            </div>
          </div>

          <!-- Badge Management -->
          <div class="bg-white rounded-lg shadow mb-6">
            <div class="p-6 border-b border-gray-200 flex items-center justify-between">
              <h3 class="text-xl font-bold text-gray-800">Badge Management</h3>
              <button onclick="showCreateBadgeModal()" class="bg-cvsu-green text-white px-4 py-2 rounded-lg font-semibold hover-cvsu transition flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Create Badge
              </button>
            </div>
            <div class="p-6">
              <div id="badgesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Badges will be loaded here -->
              </div>
            </div>
          </div>

          <!-- User Management (Director Only) -->
          ${currentUserRole === 'director' ? `
            <div class="bg-white rounded-lg shadow">
              <div class="p-6 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-xl font-bold text-gray-800">User Management</h3>
                <div class="flex items-center gap-3">
                  <span class="badge bg-red-100 text-red-700">DIRECTOR ONLY</span>
                  <button onclick="loadAllUsers()" class="text-cvsu-green hover:underline font-semibold text-sm">Refresh</button>
                </div>
              </div>
              <div class="p-6">
                <div id="usersList" class="space-y-4">
                  <div class="text-center py-8">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="text-gray-600">Loading users...</p>
                  </div>
                </div>
              </div>
            </div>
          ` : ''}
        </div>
      `;
    }

    // User Management Functions
    let allUsers = [];

    // Load all users from Firebase
    async function loadAllUsers() {
      try {
        const usersSnapshot = await database.ref('users').once('value');
        if (usersSnapshot.exists()) {
          allUsers = Object.entries(usersSnapshot.val()).map(([uid, data]) => ({
            uid,
            ...data
          }));
        } else {
          allUsers = [];
        }
        displayUsers();
      } catch (error) {
        console.error('Error loading users:', error);
        showToast('Failed to load users: ' + error.message, 'error');
      }
    }

    // Display users in admin panel
    function displayUsers() {
      const usersList = document.getElementById('usersList');
      if (!usersList) return;

      if (allUsers.length === 0) {
        usersList.innerHTML = '<p class="text-gray-500 text-center py-8">No users found</p>';
        return;
      }

      usersList.innerHTML = allUsers.map(user => `
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:shadow-md transition">
          <div class="flex items-center gap-4">
            <img src="${user.profilePic || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'%23006400\'%3E%3Cpath d=\'M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z\'/%3E%3C/svg%3E'}" alt="${user.name}" class="w-12 h-12 rounded-full object-cover bg-white">
            <div>
              <p class="font-semibold text-gray-800">${user.name || 'Unknown User'}</p>
              <p class="text-sm text-gray-600">${user.email || 'No email'}</p>
              <p class="text-xs text-gray-500">Joined ${getTimeAgo(user.joinDate || Date.now())}</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <span class="badge ${getRoleBadgeColor(user.role)}">${(user.role || 'guest').toUpperCase()}</span>
            ${user.uid !== currentUser.uid ? `
              <button onclick="changeUserRole('${user.uid}', '${user.name}', '${user.role}')" class="text-cvsu-green hover:text-cvsu-green-dark font-semibold text-sm">
                Change Role
              </button>
            ` : '<span class="text-xs text-gray-500">(You)</span>'}
          </div>
        </div>
      `).join('');
    }

    // Get badge color based on role
    function getRoleBadgeColor(role) {
      const colors = {
        'director': 'bg-red-100 text-red-700',
        'officer': 'bg-purple-100 text-purple-700',
        'aa_member': 'bg-blue-100 text-blue-700',
        'teacher': 'bg-green-100 text-green-700',
        'student': 'bg-yellow-100 text-yellow-700',
        'guest': 'bg-gray-100 text-gray-700'
      };
      return colors[role] || colors['guest'];
    }

    // Change user role
    function changeUserRole(uid, userName, currentRole) {
      const modal = document.createElement('div');
      modal.id = 'changeRoleModal';
      modal.className = 'fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-2xl max-w-md w-full p-8 fade-in">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-cvsu-green">Change User Role</h2>
            <button id="closeRoleModal" class="text-gray-400 hover:text-gray-600 transition">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <div class="mb-6">
            <p class="text-gray-700 mb-2">User: <span class="font-semibold">${userName}</span></p>
            <p class="text-gray-600 text-sm">Current Role: <span class="badge ${getRoleBadgeColor(currentRole)}">${(currentRole || 'guest').toUpperCase()}</span></p>
          </div>

          <form id="changeRoleForm" class="space-y-4">
            <div>
              <label for="newRole" class="block text-sm font-semibold text-gray-700 mb-2">New Role</label>
              <select id="newRole" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cvsu-green focus:border-transparent">
                <option value="guest" ${currentRole === 'guest' ? 'selected' : ''}>Guest</option>
                <option value="student" ${currentRole === 'student' ? 'selected' : ''}>Student</option>
                <option value="teacher" ${currentRole === 'teacher' ? 'selected' : ''}>Teacher</option>
                <option value="aa_member" ${currentRole === 'aa_member' ? 'selected' : ''}>AA Member</option>
                <option value="officer" ${currentRole === 'officer' ? 'selected' : ''}>Officer</option>
                <option value="director" ${currentRole === 'director' ? 'selected' : ''}>Director</option>
              </select>
            </div>

            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
              <p class="text-sm text-yellow-800">
                <strong>Warning:</strong> Changing a user's role will affect their permissions immediately.
              </p>
            </div>

            <div class="flex gap-3 pt-4">
              <button type="button" id="cancelRoleChange" class="flex-1 px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50 transition">
                Cancel
              </button>
              <button type="submit" class="flex-1 bg-cvsu-green text-white px-6 py-3 rounded-lg font-semibold hover-cvsu transition">
                Update Role
              </button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);

      document.getElementById('closeRoleModal').addEventListener('click', () => {
        modal.remove();
      });

      document.getElementById('cancelRoleChange').addEventListener('click', () => {
        modal.remove();
      });

      document.getElementById('changeRoleForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const newRole = document.getElementById('newRole').value;
        
        if (newRole === currentRole) {
          showToast('No changes made', 'info');
          modal.remove();
          return;
        }

        showToast('Updating user role...', 'info');

        try {
          await database.ref('users/' + uid).update({ role: newRole });
          
          showToast(`Successfully changed ${userName}'s role to ${newRole.toUpperCase()}!`, 'success');
          modal.remove();
          
          // Reload users
          await loadAllUsers();
        } catch (error) {
          console.error('Role change error:', error);
          showToast('Failed to change role: ' + error.message, 'error');
        }
      });
    }

    // Delete resource function
    async function deleteResource(resourceId) {
      const confirmDelete = document.createElement('div');
      confirmDelete.className = 'fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4';
      confirmDelete.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-2">Confirm Deletion</h3>
          <p class="text-gray-600 mb-6">Are you sure you want to delete this resource? This action cannot be undone.</p>
          <div class="flex gap-3">
            <button id="cancelDelete" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg font-semibold hover:bg-gray-50 transition">
              Cancel
            </button>
            <button id="confirmDelete" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition">
              Delete
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmDelete);

      document.getElementById('cancelDelete').addEventListener('click', () => {
        confirmDelete.remove();
      });

      document.getElementById('confirmDelete').addEventListener('click', async () => {
        try {
          await database.ref('resources/' + resourceId).remove();
          showToast('Resource deleted successfully', 'success');
          confirmDelete.remove();
          await loadAllData();
          loadPage('admin');
        } catch (error) {
          showToast('Failed to delete resource: ' + error.message, 'error');
        }
      });
    }

    // Badge Management Functions
    let allBadges = [];

    // Load badges from Firebase
    async function loadBadges() {
      try {
        const badgesSnapshot = await database.ref('badges').once('value');
        if (badgesSnapshot.exists()) {
          allBadges = Object.entries(badgesSnapshot.val()).map(([id, data]) => ({
            id,
            ...data
          }));
        } else {
          allBadges = [];
        }
        displayBadges();
      } catch (error) {
        console.error('Error loading badges:', error);
      }
    }

    // Display badges in admin panel
    function displayBadges() {
      const badgesList = document.getElementById('badgesList');
      if (!badgesList) return;

      if (allBadges.length === 0) {
        badgesList.innerHTML = '<p class="text-gray-500 text-center py-8 col-span-full">No badges created yet. Create your first badge!</p>';
        return;
      }

      badgesList.innerHTML = allBadges.map(badge => `
        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
          <div class="flex items-start justify-between mb-3">
            <div class="w-16 h-16 bg-${badge.color || 'yellow'}-100 rounded-full flex items-center justify-center text-4xl">
              ${badge.icon || '🏆'}
            </div>
            <button onclick="deleteBadge('${badge.id}')" class="text-red-600 hover:text-red-800">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
            </button>
          </div>
          <h4 class="font-bold text-gray-800 mb-1">${badge.name}</h4>
          <p class="text-sm text-gray-600 mb-2">${badge.description}</p>
          <div class="flex flex-wrap gap-1 mb-2">
            ${badge.triggers.map(trigger => `
              <span class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded-full">${trigger}</span>
            `).join('')}
          </div>
          <p class="text-xs text-gray-500">XP Reward: ${badge.xpReward || 0}</p>
        </div>
      `).join('');
    }

    // Show Create Badge Modal
    function showCreateBadgeModal() {
      const modal = document.createElement('div');
      modal.id = 'createBadgeModal';
      modal.className = 'fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full p-8 fade-in max-h-[90vh] overflow-y-auto">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-cvsu-green">Create New Badge</h2>
            <button id="closeBadgeModal" class="text-gray-400 hover:text-gray-600 transition">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <form id="createBadgeForm" class="space-y-6">
            <div>
              <label for="badgeName" class="block text-sm font-semibold text-gray-700 mb-2">Badge Name</label>
              <input type="text" id="badgeName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cvsu-green focus:border-transparent" placeholder="e.g., Forum Contributor">
            </div>

            <div>
              <label for="badgeDescription" class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
              <textarea id="badgeDescription" rows="3" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cvsu-green focus:border-transparent" placeholder="Describe what this badge represents..."></textarea>
            </div>

            <div class="grid grid-cols-2 gap-6">
              <div>
                <label for="badgeIcon" class="block text-sm font-semibold text-gray-700 mb-2">Icon (Emoji)</label>
                <input type="text" id="badgeIcon" required maxlength="2" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cvsu-green focus:border-transparent text-4xl text-center" placeholder="🏆">
                <p class="text-xs text-gray-500 mt-1">Use any emoji</p>
              </div>

              <div>
                <label for="badgeColor" class="block text-sm font-semibold text-gray-700 mb-2">Color Theme</label>
                <select id="badgeColor" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cvsu-green focus:border-transparent">
                  <option value="yellow">Gold (Yellow)</option>
                  <option value="blue">Blue</option>
                  <option value="green">Green</option>
                  <option value="purple">Purple</option>
                  <option value="red">Red</option>
                  <option value="pink">Pink</option>
                  <option value="indigo">Indigo</option>
                </select>
              </div>
            </div>

            <div>
              <label for="badgeXP" class="block text-sm font-semibold text-gray-700 mb-2">XP Reward</label>
              <input type="number" id="badgeXP" required min="0" value="100" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cvsu-green focus:border-transparent" placeholder="100">
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-3">Triggers (Select all that apply)</label>
              <div class="space-y-2 max-h-60 overflow-y-auto border border-gray-200 rounded-lg p-4">
                <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                  <input type="checkbox" name="trigger" value="forum_post_1" class="text-cvsu-green focus:ring-cvsu-green">
                  <span class="text-gray-700">First forum post</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                  <input type="checkbox" name="trigger" value="forum_post_10" class="text-cvsu-green focus:ring-cvsu-green">
                  <span class="text-gray-700">10 forum posts</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                  <input type="checkbox" name="trigger" value="forum_post_50" class="text-cvsu-green focus:ring-cvsu-green">
                  <span class="text-gray-700">50 forum posts</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                  <input type="checkbox" name="trigger" value="resource_upload_1" class="text-cvsu-green focus:ring-cvsu-green">
                  <span class="text-gray-700">First resource upload</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                  <input type="checkbox" name="trigger" value="resource_upload_5" class="text-cvsu-green focus:ring-cvsu-green">
                  <span class="text-gray-700">5 resource uploads</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                  <input type="checkbox" name="trigger" value="resource_view_10" class="text-cvsu-green focus:ring-cvsu-green">
                  <span class="text-gray-700">View 10 resources</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                  <input type="checkbox" name="trigger" value="resource_view_50" class="text-cvsu-green focus:ring-cvsu-green">
                  <span class="text-gray-700">View 50 resources</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                  <input type="checkbox" name="trigger" value="assignment_complete_1" class="text-cvsu-green focus:ring-cvsu-green">
                  <span class="text-gray-700">Complete first assignment</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                  <input type="checkbox" name="trigger" value="assignment_complete_10" class="text-cvsu-green focus:ring-cvsu-green">
                  <span class="text-gray-700">Complete 10 assignments</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                  <input type="checkbox" name="trigger" value="perfect_score" class="text-cvsu-green focus:ring-cvsu-green">
                  <span class="text-gray-700">Get perfect score on assignment</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                  <input type="checkbox" name="trigger" value="join_class" class="text-cvsu-green focus:ring-cvsu-green">
                  <span class="text-gray-700">Join first class</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                  <input type="checkbox" name="trigger" value="helpful_reply" class="text-cvsu-green focus:ring-cvsu-green">
                  <span class="text-gray-700">Receive 10 helpful reactions on forum</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                  <input type="checkbox" name="trigger" value="daily_streak_7" class="text-cvsu-green focus:ring-cvsu-green">
                  <span class="text-gray-700">7-day login streak</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                  <input type="checkbox" name="trigger" value="daily_streak_30" class="text-cvsu-green focus:ring-cvsu-green">
                  <span class="text-gray-700">30-day login streak</span>
                </label>
              </div>
            </div>

            <div class="flex gap-4 pt-4">
              <button type="button" id="cancelBadge" class="flex-1 px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50 transition">
                Cancel
              </button>
              <button type="submit" class="flex-1 bg-cvsu-green text-white px-6 py-3 rounded-lg font-semibold hover-cvsu transition">
                Create Badge
              </button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);

      // Close modal handlers
      document.getElementById('closeBadgeModal').addEventListener('click', () => {
        modal.remove();
      });

      document.getElementById('cancelBadge').addEventListener('click', () => {
        modal.remove();
      });

      // Form submission
      document.getElementById('createBadgeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const name = document.getElementById('badgeName').value.trim();
        const description = document.getElementById('badgeDescription').value.trim();
        const icon = document.getElementById('badgeIcon').value.trim();
        const color = document.getElementById('badgeColor').value;
        const xpReward = parseInt(document.getElementById('badgeXP').value);
        
        const triggerCheckboxes = document.querySelectorAll('input[name="trigger"]:checked');
        const triggers = Array.from(triggerCheckboxes).map(cb => cb.value);

        if (triggers.length === 0) {
          showToast('Please select at least one trigger', 'error');
          return;
        }

        showToast('Creating badge...', 'info');

        try {
          const badgeData = {
            name,
            description,
            icon,
            color,
            xpReward,
            triggers,
            createdBy: currentUser.uid,
            createdAt: Date.now()
          };

          await database.ref('badges').push(badgeData);
          
          showToast('Badge created successfully!', 'success');
          modal.remove();
          
          // Reload badges
          await loadBadges();
        } catch (error) {
          console.error('Badge creation error:', error);
          showToast('Failed to create badge: ' + error.message, 'error');
        }
      });
    }

    // Delete badge
    async function deleteBadge(badgeId) {
      const confirmDelete = document.createElement('div');
      confirmDelete.className = 'fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4';
      confirmDelete.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-2">Confirm Deletion</h3>
          <p class="text-gray-600 mb-6">Are you sure you want to delete this badge? Users who earned it will keep it, but no new users can earn it.</p>
          <div class="flex gap-3">
            <button id="cancelDeleteBadge" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg font-semibold hover:bg-gray-50 transition">
              Cancel
            </button>
            <button id="confirmDeleteBadge" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition">
              Delete
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmDelete);

      document.getElementById('cancelDeleteBadge').addEventListener('click', () => {
        confirmDelete.remove();
      });

      document.getElementById('confirmDeleteBadge').addEventListener('click', async () => {
        try {
          await database.ref('badges/' + badgeId).remove();
          showToast('Badge deleted successfully', 'success');
          confirmDelete.remove();
          await loadBadges();
        } catch (error) {
          showToast('Failed to delete badge: ' + error.message, 'error');
        }
      });
    }

    // Modal functions (placeholders)
    function showCreateResourceModal() {
      loadPage('upload');
    }

    function showCreateAnnouncementModal() {
      showToast('Announcement creation feature coming soon!', 'info');
    }

    function showCreateClassModal() {
      showToast('Class creation feature coming soon!', 'info');
    }

    // Show Create Forum Topic Modal
    function showCreateTopicModal() {
      const modal = document.createElement('div');
      modal.id = 'createTopicModal';
      modal.className = 'fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full p-8 fade-in max-h-[90vh] overflow-y-auto">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-cvsu-green">Start New Discussion</h2>
            <button id="closeTopicModal" class="text-gray-400 hover:text-gray-600 transition">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <form id="createTopicForm" class="space-y-6">
            <div>
              <label for="topicTitle" class="block text-sm font-semibold text-gray-700 mb-2">Topic Title</label>
              <input type="text" id="topicTitle" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cvsu-green focus:border-transparent" placeholder="What's your question or topic?">
            </div>

            <div>
              <label for="topicCategory" class="block text-sm font-semibold text-gray-700 mb-2">Category</label>
              <select id="topicCategory" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cvsu-green focus:border-transparent">
                <option value="">Select a category</option>
                <option value="Computer Science">💻 Computer Science</option>
                <option value="Mathematics">📐 Mathematics</option>
                <option value="Physics">⚡ Physics</option>
                <option value="Chemistry">🧪 Chemistry</option>
                <option value="General Discussion">💬 General Discussion</option>
                <option value="Questions & Answers">❓ Questions & Answers</option>
              </select>
            </div>

            <div>
              <label for="topicContent" class="block text-sm font-semibold text-gray-700 mb-2">Content</label>
              <textarea id="topicContent" rows="6" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cvsu-green focus:border-transparent" placeholder="Describe your question or start the discussion..."></textarea>
            </div>

            <div class="flex gap-4 pt-4">
              <button type="button" id="cancelTopic" class="flex-1 px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50 transition">
                Cancel
              </button>
              <button type="submit" class="flex-1 bg-cvsu-green text-white px-6 py-3 rounded-lg font-semibold hover-cvsu transition">
                Post Topic
              </button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);

      document.getElementById('closeTopicModal').addEventListener('click', () => {
        modal.remove();
      });

      document.getElementById('cancelTopic').addEventListener('click', () => {
        modal.remove();
      });

      document.getElementById('createTopicForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const title = document.getElementById('topicTitle').value.trim();
        const category = document.getElementById('topicCategory').value;
        const content = document.getElementById('topicContent').value.trim();

        if (!title || !category || !content) {
          showToast('Please fill in all fields', 'error');
          return;
        }

        showToast('Creating topic...', 'info');

        try {
          const topicData = {
            title,
            category,
            content,
            author: currentUser.displayName || 'Anonymous',
            authorId: currentUser.uid,
            date: Date.now(),
            replies: 0,
            replyList: []
          };

          await database.ref('forums').push(topicData);
          
          showToast('Topic created successfully!', 'success');
          modal.remove();
          
          await loadAllData();
          loadPage('forums');
        } catch (error) {
          console.error('Topic creation error:', error);
          showToast('Failed to create topic: ' + error.message, 'error');
        }
      });
    }

    // Filter forum by category
    function filterForumByCategory(category) {
      const filteredTopics = allForumTopics.filter(t => t.category === category);
      
      const modal = document.createElement('div');
      modal.id = 'categoryModal';
      modal.className = 'fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden fade-in flex flex-col">
          <div class="p-6 border-b border-gray-200 flex items-center justify-between bg-cvsu-green text-white">
            <h2 class="text-2xl font-bold">${category}</h2>
            <button id="closeCategoryModal" class="hover:bg-cvsu-green-dark p-2 rounded-lg transition">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          
          <div class="flex-1 overflow-y-auto p-6">
            <div class="divide-y divide-gray-200">
              ${filteredTopics.length > 0 ? filteredTopics.map(topic => `
                <div onclick="document.getElementById('categoryModal').remove(); openForumTopic('${topic.id}')" class="p-5 hover:bg-gray-50 cursor-pointer transition">
                  <div class="flex items-start justify-between">
                    <div class="flex-1">
                      <h4 class="font-semibold text-gray-800 mb-1">${topic.title}</h4>
                      <div class="flex items-center gap-3 text-sm text-gray-600">
                        <span>By ${topic.author}</span>
                        <span>•</span>
                        <span>${topic.replies || 0} replies</span>
                      </div>
                    </div>
                    <span class="text-sm text-gray-500">${getTimeAgo(topic.date)}</span>
                  </div>
                </div>
              `).join('') : '<p class="text-gray-500 text-center py-8">No topics in this category yet</p>'}
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      document.getElementById('closeCategoryModal').addEventListener('click', () => {
        modal.remove();
      });
    }

    // Open forum topic
    function openForumTopic(topicId) {
      const topic = allForumTopics.find(t => t.id === topicId);
      if (!topic) {
        showToast('Topic not found', 'error');
        return;
      }

      const modal = document.createElement('div');
      modal.id = 'topicDetailModal';
      modal.className = 'fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden fade-in flex flex-col">
          <div class="p-6 border-b border-gray-200 flex items-center justify-between bg-cvsu-green text-white">
            <div class="flex-1">
              <h2 class="text-2xl font-bold mb-1">${topic.title}</h2>
              <p class="text-sm opacity-90">Posted by ${topic.author} • ${getTimeAgo(topic.date)}</p>
            </div>
            <button id="closeTopicDetail" class="hover:bg-cvsu-green-dark p-2 rounded-lg transition">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          
          <div class="flex-1 overflow-y-auto p-6">
            <div class="bg-gray-50 rounded-lg p-6 mb-6">
              <p class="text-gray-800 whitespace-pre-wrap">${topic.content}</p>
            </div>

            <div class="mb-6">
              <h3 class="text-xl font-bold text-gray-800 mb-4">${topic.replies || 0} Replies</h3>
              <div id="repliesList" class="space-y-4">
                ${topic.replyList && topic.replyList.length > 0 ? topic.replyList.map(reply => `
                  <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <div class="flex items-start gap-3 mb-2">
                      <div class="w-10 h-10 bg-cvsu-green rounded-full flex items-center justify-center text-white font-bold">
                        ${(reply.author || 'U')[0]}
                      </div>
                      <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                          <span class="font-semibold text-gray-800">${reply.author}</span>
                          <span class="text-sm text-gray-500">${getTimeAgo(reply.date)}</span>
                        </div>
                        <p class="text-gray-700">${reply.content}</p>
                      </div>
                    </div>
                  </div>
                `).join('') : '<p class="text-gray-500 text-center py-4">No replies yet. Be the first to reply!</p>'}
              </div>
            </div>

            <div class="bg-gray-50 rounded-lg p-6">
              <h4 class="font-bold text-gray-800 mb-4">Post a Reply</h4>
              <form id="replyForm" class="space-y-4">
                <textarea id="replyContent" rows="4" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cvsu-green focus:border-transparent" placeholder="Write your reply..."></textarea>
                <button type="submit" class="bg-cvsu-green text-white px-6 py-3 rounded-lg font-semibold hover-cvsu transition">
                  Post Reply
                </button>
              </form>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      document.getElementById('closeTopicDetail').addEventListener('click', () => {
        modal.remove();
      });

      document.getElementById('replyForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const replyContent = document.getElementById('replyContent').value.trim();
        if (!replyContent) {
          showToast('Please write a reply', 'error');
          return;
        }

        showToast('Posting reply...', 'info');

        try {
          const reply = {
            author: currentUser.displayName || 'Anonymous',
            authorId: currentUser.uid,
            content: replyContent,
            date: Date.now()
          };

          const replyList = topic.replyList || [];
          replyList.push(reply);

          await database.ref('forums/' + topicId).update({
            replyList: replyList,
            replies: replyList.length
          });

          showToast('Reply posted successfully!', 'success');
          document.getElementById('replyContent').value = '';
          
          await loadAllData();
          modal.remove();
          openForumTopic(topicId);
        } catch (error) {
          console.error('Reply posting error:', error);
          showToast('Failed to post reply: ' + error.message, 'error');
        }
      });
    }

    // Settings Page
    function getSettingsContent() {
      return `
        <div class="fade-in max-w-4xl">
          <h2 class="text-3xl font-bold text-gray-800 mb-6">Settings</h2>

          <div class="space-y-6">
            <!-- Account Settings -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="text-xl font-bold text-gray-800 mb-4">Account Settings</h3>
              <div class="space-y-4">
                <div>
                  <label for="settingsEmail" class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                  <input type="email" id="settingsEmail" value="${currentUser.email}" disabled class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50">
                </div>
                <div>
                  <label for="settingsName" class="block text-sm font-semibold text-gray-700 mb-2">Display Name</label>
                  <input type="text" id="settingsName" value="${currentUser.displayName || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cvsu-green focus:border-transparent">
                </div>
                <button class="settings-save-btn bg-cvsu-green text-white px-6 py-2 rounded-lg font-semibold hover-cvsu transition">
                  Save Changes
                </button>
              </div>
            </div>

            <!-- Notification Settings -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="text-xl font-bold text-gray-800 mb-4">Notifications</h3>
              <div class="space-y-4">
                <label class="flex items-center justify-between cursor-pointer">
                  <span class="text-gray-700">Email notifications</span>
                  <input type="checkbox" checked class="toggle">
                </label>
                <label class="flex items-center justify-between cursor-pointer">
                  <span class="text-gray-700">Push notifications</span>
                  <input type="checkbox" checked class="toggle">
                </label>
                <label class="flex items-center justify-between cursor-pointer">
                  <span class="text-gray-700">Assignment reminders</span>
                  <input type="checkbox" checked class="toggle">
                </label>
                <label class="flex items-center justify-between cursor-pointer">
                  <span class="text-gray-700">Forum replies</span>
                  <input type="checkbox" class="toggle">
                </label>
              </div>
            </div>

            <!-- Appearance -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="text-xl font-bold text-gray-800 mb-4">Appearance</h3>
              <div class="space-y-4">
                <div>
                  <label for="fontSize" class="block text-sm font-semibold text-gray-700 mb-2">Font Size</label>
                  <select id="fontSize" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cvsu-green focus:border-transparent">
                    <option>Small</option>
                    <option selected>Medium</option>
                    <option>Large</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Privacy -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="text-xl font-bold text-gray-800 mb-4">Privacy</h3>
              <div class="space-y-4">
                <label class="flex items-center justify-between cursor-pointer">
                  <span class="text-gray-700">Public profile</span>
                  <input type="checkbox" checked class="toggle">
                </label>
                <label class="flex items-center justify-between cursor-pointer">
                  <span class="text-gray-700">Show activity timeline</span>
                  <input type="checkbox" checked class="toggle">
                </label>
                <label class="flex items-center justify-between cursor-pointer">
                  <span class="text-gray-700">Show badges</span>
                  <input type="checkbox" checked class="toggle">
                </label>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Helper: Generate Resource Card
    function generateResourceCard(title, author, type, course, size, views, isPPT = false, resourceId = null, fileURL = null) {
      const typeColor = isPPT ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700';
      const icon = isPPT ? 
        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>' :
        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>';
      
      return `
        <div class="bg-white rounded-lg shadow card-hover p-5 cursor-pointer resource-card" data-resource-id="${resourceId}" data-file-url="${fileURL || ''}">
          <div class="flex items-start justify-between mb-3">
            <div class="w-12 h-12 bg-cvsu-green rounded-lg flex items-center justify-center flex-shrink-0">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                ${icon}
              </svg>
            </div>
            <button class="text-gray-400 hover:text-gray-600 resource-download" data-file-url="${fileURL || ''}" data-file-name="${title}">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
              </svg>
            </button>
          </div>
          <h4 class="font-bold text-gray-800 mb-2 line-clamp-2">${title}</h4>
          <p class="text-sm text-gray-600 mb-3">By ${author}</p>
          <div class="flex flex-wrap gap-2 mb-3">
            <span class="badge ${typeColor}">${type}</span>
            <span class="badge bg-purple-100 text-purple-700">${course}</span>
          </div>
          <div class="flex items-center justify-between text-sm text-gray-500">
            <span>${size}</span>
            <span>${views}</span>
          </div>
        </div>
      `;
    }

    // Helper: Generate Class Card
    function generateClassCard(name, teacher, students, code) {
      return `
        <div class="bg-white rounded-lg shadow card-hover overflow-hidden cursor-pointer">
          <div class="h-32 bg-gradient-to-br from-cvsu-green to-cvsu-green-light"></div>
          <div class="p-5">
            <h4 class="font-bold text-gray-800 mb-2">${name}</h4>
            <p class="text-sm text-gray-600 mb-3">${teacher}</p>
            <div class="flex items-center justify-between">
              <span class="badge bg-blue-100 text-blue-700">${code}</span>
              <span class="text-sm text-gray-500">${students}</span>
            </div>
          </div>
        </div>
      `;
    }

    // Helper: Generate Assignment Card
    function generateAssignmentCard(title, course, deadline, urgency, grade = null) {
      const urgencyColors = {
        urgent: 'border-red-500 bg-red-50',
        warning: 'border-yellow-500 bg-yellow-50',
        normal: 'border-blue-500 bg-blue-50',
        completed: 'border-green-500 bg-green-50'
      };
      
      return `
        <div class="border-l-4 ${urgencyColors[urgency]} p-4 rounded cursor-pointer hover:shadow-md transition">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <h4 class="font-bold text-gray-800 mb-1">${title}</h4>
              <p class="text-sm text-gray-600">${course}</p>
              <p class="text-sm ${urgency === 'urgent' ? 'text-red-600 font-semibold' : 'text-gray-500'} mt-2">
                ${urgency === 'completed' ? `Grade: ${grade}` : `Due: ${deadline}`}
              </p>
            </div>
            ${urgency !== 'completed' ? `
              <button class="bg-cvsu-green text-white px-4 py-2 rounded-lg text-sm font-semibold hover-cvsu transition">
                Submit
              </button>
            ` : `
              <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            `}
          </div>
        </div>
      `;
    }

    // Helper: Generate Announcement Card
    function generateAnnouncementCard(title, content, category, color, time, pinned = false) {
      return `
        <div class="bg-white rounded-lg shadow p-6 ${pinned ? 'border-2 border-cvsu-green' : ''}">
          <div class="flex items-start justify-between mb-3">
            <div class="flex items-center gap-2">
              ${pinned ? `<svg class="w-5 h-5 text-cvsu-green" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1.323l3.954 1.582 1.599-.8a1 1 0 01.894 1.79l-1.233.616 1.738 5.42a1 1 0 01-.285 1.05A3.989 3.989 0 0115 15a3.989 3.989 0 01-2.667-1.019 1 1 0 01-.285-1.05l1.738-5.42-1.233-.617a1 1 0 01.894-1.788l1.599.799L11 4.323V3a1 1 0 011-1h-2zM5.5 9A1.5 1.5 0 104 7.5 1.5 1.5 0 005.5 9z"/></svg>` : ''}
              <span class="badge bg-${color}-100 text-${color}-700">${category}</span>
            </div>
            <span class="text-sm text-gray-500">${time}</span>
          </div>
          <h4 class="font-bold text-gray-800 text-lg mb-2">${title}</h4>
          <p class="text-gray-600">${content}</p>
        </div>
      `;
    }

    // Helper: Generate Forum Room
    function generateForumRoom(icon, name, topics, posts) {
      return `
        <div onclick="filterForumByCategory('${name}')" class="bg-white rounded-lg shadow card-hover p-6 cursor-pointer">
          <div class="text-4xl mb-3">${icon}</div>
          <h4 class="font-bold text-gray-800 mb-2">${name}</h4>
          <div class="flex items-center gap-4 text-sm text-gray-600">
            <span>${topics}</span>
            <span>${posts}</span>
          </div>
        </div>
      `;
    }

    // Helper: Generate Forum Post
    function generateForumPost(title, author, category, replies, time) {
      return `
        <div class="p-5 hover:bg-gray-50 cursor-pointer transition">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <h4 class="font-semibold text-gray-800 mb-1">${title}</h4>
              <div class="flex items-center gap-3 text-sm text-gray-600">
                <span>By ${author}</span>
                <span>���</span>
                <span class="badge bg-gray-100 text-gray-700">${category}</span>
                <span>•</span>
                <span>${replies}</span>
              </div>
            </div>
            <span class="text-sm text-gray-500">${time}</span>
          </div>
        </div>
      `;
    }

    // Helper: Get time ago
    function getTimeAgo(timestamp) {
      const seconds = Math.floor((Date.now() - timestamp) / 1000);
      
      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return `${Math.floor(seconds / 60)} minutes ago`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
      if (seconds < 604800) return `${Math.floor(seconds / 86400)} days ago`;
      return new Date(timestamp).toLocaleDateString();
    }

    // Initialize Elements SDK
    const defaultConfig = {};
    
    const elementApi = {
      defaultConfig,
      onConfigChange: async (config) => {
        // No config-driven updates needed for this app
      },
      mapToCapabilities: (config) => ({
        recolorables: [],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      }),
      mapToEditPanelValues: (config) => new Map()
    };

    if (window.elementSdk) {
      window.elementSdk.init(elementApi);
    }

  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a5221b9b1aa9fa1',t:'MTc2NDI1MTgxOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
